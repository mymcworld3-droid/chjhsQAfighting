<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ¯æ—¥å‡éšç­”é¡Œæˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .page-section { display: none; } /* é è¨­éš±è—æ‰€æœ‰é é¢ */
        .active-page { display: block; } /* é¡¯ç¤ºç•¶å‰é é¢ */
        body { background-color: #0f172a; color: white; }
        /* ç°¡å–®çš„è¼‰å…¥å‹•ç•« */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="font-sans h-screen flex flex-col overflow-hidden">

    <header class="p-4 bg-slate-800 shadow-lg flex justify-between items-center z-10">
        <h1 class="text-xl font-bold text-yellow-400"><i class="fa-solid fa-crown"></i> AI å‡éšæˆ°</h1>
        <div id="user-info" class="text-xs text-gray-300">æœªç™»å…¥</div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 relative scroll-smooth">
        
        <div id="login-screen" class="flex flex-col items-center justify-center h-full">
            <div class="text-center mb-8">
                <i class="fa-solid fa-dragon text-6xl text-yellow-500 mb-4"></i>
                <h2 class="text-3xl font-bold">æ­¡è¿ä¾†åˆ°ç­”é¡Œæˆ°å ´</h2>
                <p class="text-gray-400 mt-2">æŒ‘æˆ° AI å‡ºé¡Œï¼Œå¾é’éŠ…é‚å‘æ˜Ÿè€€</p>
            </div>
            <button onclick="googleLogin()" class="bg-white text-gray-800 hover:bg-gray-100 px-8 py-3 rounded-full font-bold shadow-lg transition flex items-center gap-2">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                ä½¿ç”¨ Google ç™»å…¥
            </button>
        </div>

        <div id="page-home" class="page-section hidden">
            <div class="bg-slate-800 p-8 rounded-2xl shadow-xl text-center border border-slate-700">
                <div class="text-gray-400 text-sm mb-2">ç•¶å‰æ®µä½</div>
                <h2 class="text-4xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500" id="display-rank">è®€å–ä¸­...</h2>
                
                <div class="flex justify-center items-center gap-2 mt-4 text-gray-300">
                    <i class="fa-solid fa-star text-yellow-400"></i>
                    <span>éšæ®µ: <span id="display-stars" class="font-bold text-white">0</span>/10</span>
                </div>

                <div class="w-full bg-slate-900 rounded-full h-4 mt-4 overflow-hidden border border-slate-600">
                    <div id="progress-bar" class="bg-gradient-to-r from-yellow-500 to-orange-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>

                <button onclick="startQuizFlow()" class="mt-8 bg-blue-600 w-full py-4 rounded-xl text-xl font-bold hover:bg-blue-500 shadow-lg transform active:scale-95 transition">
                    <i class="fa-solid fa-play"></i> é–‹å§‹æŒ‘æˆ°
                </button>
            </div>

            <div class="mt-6">
                <h3 class="text-sm font-bold text-gray-400 mb-2 uppercase">éŠæˆ²èªªæ˜</h3>
                <div class="bg-slate-800 p-4 rounded-lg text-sm text-gray-300 space-y-2">
                    <p>âœ… ç­”å°ä¸€é¡Œï¼šæ˜Ÿæ˜Ÿ +1</p>
                    <p>âŒ ç­”éŒ¯ä¸€é¡Œï¼šæ˜Ÿæ˜Ÿ -1 (å¯èƒ½å°è‡´é™éš)</p>
                    <p>ğŸ¯ æ»¿ 10 æ˜Ÿï¼šæ™‰å‡ä¸‹ä¸€å€‹æ®µä½</p>
                </div>
            </div>
        </div>

        <div id="page-quiz" class="page-section hidden">
            <div id="quiz-loading" class="text-center mt-20 hidden">
                <div class="loader"></div>
                <p class="text-xl animate-pulse text-blue-300">AI è€ƒå®˜æ­£åœ¨å‡ºé¡Œä¸­...</p>
                <p class="text-xs text-gray-500 mt-2">æ ¹æ“šæ‚¨çš„èˆˆè¶£èˆ‡ç­‰ç´šç”Ÿæˆ</p>
            </div>

            <div id="quiz-container" class="hidden">
                <div class="bg-slate-800 p-6 rounded-xl mb-6 border-l-4 border-blue-500 shadow-lg">
                    <div class="flex justify-between items-center mb-3">
                        <span class="bg-blue-900 text-blue-200 text-xs font-bold px-2 py-1 rounded" id="quiz-badge">ä¸»é¡Œ</span>
                        <span class="text-xs text-gray-400">å–®é¸é¡Œ</span>
                    </div>
                    <h3 class="text-lg font-bold leading-relaxed" id="question-text">é¡Œç›®è¼‰å…¥ä¸­...</h3>
                </div>

                <div id="options-container" class="space-y-3">
                    </div>
                
                <button onclick="switchToPage('page-home')" class="mt-8 text-gray-500 text-sm w-full text-center hover:text-white">æ”¾æ£„ä¸¦è¿”å›</button>
            </div>
        </div>

        <div id="page-rank" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-trophy text-yellow-400"></i> å…¨æœæ’è¡Œæ¦œ
            </h2>
            <div class="bg-slate-800 rounded-xl overflow-hidden shadow-lg">
                <table class="w-full text-left text-sm text-gray-300">
                    <thead class="bg-slate-700 text-gray-100 uppercase text-xs">
                        <tr>
                            <th class="px-4 py-3">#</th>
                            <th class="px-4 py-3">ç©å®¶</th>
                            <th class="px-4 py-3 text-right">æ®µä½</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="page-settings" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-4">âš™ï¸ å€‹äººæª”æ¡ˆ</h2>
            
            <div class="bg-slate-800 p-6 rounded-xl shadow-lg mb-6">
                <label class="block mb-2 text-sm font-bold text-blue-300">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> å‡ºé¡Œèˆˆè¶£åå¥½
                </label>
                <p class="text-xs text-gray-400 mb-3">AI æœƒå„ªå…ˆé‡å°é€™äº›ä¸»é¡Œå‡ºé¡Œ (ç”¨é€—è™Ÿåˆ†éš”)</p>
                <input type="text" id="input-interests" class="bg-slate-900 border border-slate-600 text-white text-sm rounded-lg w-full p-3 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="ä¾‹å¦‚ï¼šå°ç£æ­·å², Javascript, æ¼«å¨é›»å½±">
                <button onclick="saveProfile()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg w-full font-bold hover:bg-blue-500 transition">
                    å„²å­˜è¨­å®š
                </button>
            </div>

            <button onclick="logout()" class="bg-red-900/50 border border-red-800 text-red-200 px-4 py-3 rounded-lg w-full hover:bg-red-900 transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-right-from-bracket"></i> ç™»å‡ºå¸³è™Ÿ
            </button>
        </div>

        <div id="page-admin" class="page-section hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-red-400"><i class="fa-solid fa-shield-halved"></i> ç®¡ç†å“¡å¾Œå°</h2>
                <button onclick="loadAdminLogs()" class="text-xs bg-slate-700 px-3 py-1 rounded hover:bg-slate-600">åˆ·æ–°æ—¥èªŒ</button>
            </div>
            
            <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 h-[70vh] flex flex-col">
                <div class="p-3 bg-slate-900 border-b border-slate-700 font-bold text-sm">
                    å³æ™‚ç­”é¡Œç›£æ§
                </div>
                <ul id="admin-logs-list" class="overflow-y-auto p-2 space-y-2 flex-1">
                    <li class="text-center text-gray-500 py-4">é»æ“Šåˆ·æ–°è¼‰å…¥æ•¸æ“š...</li>
                </ul>
            </div>
        </div>

    </main>

    <nav id="bottom-nav" class="bg-slate-800 border-t border-slate-700 hidden pb-safe">
        <div class="grid h-16 grid-cols-4 mx-auto font-medium" id="nav-grid">
            <button onclick="switchToPage('page-home')" class="flex flex-col items-center justify-center hover:bg-slate-700 text-gray-400 hover:text-white transition group">
                <i class="fa-solid fa-house mb-1 text-lg group-hover:text-blue-400"></i>
                <span class="text-[10px]">é¦–é </span>
            </button>
            <button onclick="startQuizFlow()" class="flex flex-col items-center justify-center hover:bg-slate-700 text-gray-400 hover:text-white transition group">
                <i class="fa-solid fa-swords mb-1 text-lg group-hover:text-red-400"></i>
                <span class="text-[10px]">ç­”é¡Œ</span>
            </button>
            <button onclick="loadLeaderboard(); switchToPage('page-rank')" class="flex flex-col items-center justify-center hover:bg-slate-700 text-gray-400 hover:text-white transition group">
                <i class="fa-solid fa-chart-simple mb-1 text-lg group-hover:text-yellow-400"></i>
                <span class="text-[10px]">æ’è¡Œ</span>
            </button>
            <button onclick="switchToPage('page-settings')" class="flex flex-col items-center justify-center hover:bg-slate-700 text-gray-400 hover:text-white transition group">
                <i class="fa-solid fa-user-gear mb-1 text-lg group-hover:text-green-400"></i>
                <span class="text-[10px]">è¨­å®š</span>
            </button>
            </div>
    </nav>

    <script type="module">
        // 1. å¼•å…¥å¿…è¦çš„ Firebase èˆ‡ Gemini æ¨¡çµ„ (CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // 2. è¨­å®šæª”å€åŸŸ
        const firebaseConfig = {
            apiKey: "AIzaSyDifdJmLTmwQATz__xUHSkXZ_xXOWyX-wU",
            authDomain: "question-learning.firebaseapp.com",
            projectId: "question-learning",
            storageBucket: "question-learning.firebasestorage.app",
            messagingSenderId: "1058543232092",
            appId: "1:1058543232092:web:3fcc40f5f069b6df307299",
            measurementId: "G-76ER8RGBN7"
        };

        // âš ï¸âš ï¸âš ï¸ è«‹åœ¨æ­¤å¡«å…¥ä½ çš„ Gemini API Key âš ï¸âš ï¸âš ï¸
        const GEMINI_API_KEY = "AIzaSyCVhmPZlA84487vG286-McCm8HBHv3K2Mw"; 

        // 3. åˆå§‹åŒ–ç³»çµ±
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();
        const provider = new GoogleAuthProvider();
        
        // æª¢æŸ¥ API Key
        let genAI;
        if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE" || GEMINI_API_KEY === "") {
            console.error("å°šæœªå¡«å¯« Gemini API Key");
            alert("è«‹ç·¨è¼¯ç¨‹å¼ç¢¼ï¼Œå¡«å…¥ä½ çš„ Gemini API Key æ‰èƒ½é–‹å§‹å‡ºé¡Œï¼");
        } else {
            genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
        }

        // éŠæˆ²å…¨åŸŸè®Šæ•¸
        let currentUserData = null;
        const RANKS = ["ğŸ¥‰ é’éŠ…", "ğŸ¥ˆ ç™½éŠ€", "ğŸ¥‡ é»ƒé‡‘", "ğŸ’ é‰‘é‡‘", "ğŸ”· é‘½çŸ³", "ğŸŒŸ æ˜Ÿè€€"];

        // 4. èº«ä»½é©—è­‰é‚è¼¯
        window.googleLogin = () => {
            signInWithPopup(auth, provider).catch((error) => {
                alert("ç™»å…¥å¤±æ•—: " + error.message);
            });
        };

        window.logout = () => {
            signOut(auth).then(() => location.reload());
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // UI åˆ‡æ›
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('bottom-nav').classList.remove('hidden');
                document.getElementById('user-info').innerHTML = `<i class="fa-solid fa-user"></i> ${user.displayName}`;

                // è®€å–/å‰µå»º User è³‡æ–™
                const userRef = doc(db, "users", user.uid);
                try {
                    const docSnap = await getDoc(userRef);
                    if (docSnap.exists()) {
                        currentUserData = docSnap.data();
                        document.getElementById('input-interests').value = currentUserData.profile?.interests || "";
                    } else {
                        // æ–°ç”¨æˆ¶é è¨­å€¼
                        currentUserData = {
                            uid: user.uid,
                            displayName: user.displayName,
                            email: user.email,
                            profile: { interests: "ç”Ÿæ´»å¸¸è­˜" },
                            stats: { rankLevel: 0, currentStars: 0, totalScore: 0 },
                            isAdmin: false
                        };
                        await setDoc(userRef, currentUserData);
                    }
                    
                    // ç®¡ç†å“¡æª¢æŸ¥
                    checkAdminRole(currentUserData.isAdmin);
                    
                    // æ›´æ–°ç•«é¢ä¸¦è·³è½‰é¦–é 
                    updateUIStats();
                    switchToPage('page-home');

                } catch (error) {
                    console.error("Firestore Error:", error);
                    alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firestore æ¬Šé™è¦å‰‡ (Rules)ã€‚");
                }
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('bottom-nav').classList.add('hidden');
            }
        });

        // 5. æ ¸å¿ƒåŠŸèƒ½ï¼šé é¢åˆ‡æ›èˆ‡ UI æ›´æ–°
        window.switchToPage = (pageId) => {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active-page', 'hidden'));
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            document.getElementById(pageId).classList.add('active-page');
        };

        function updateUIStats() {
            if(!currentUserData) return;
            const { rankLevel, currentStars } = currentUserData.stats;
            
            document.getElementById('display-rank').innerText = RANKS[rankLevel];
            document.getElementById('display-stars').innerText = currentStars;
            // è¨ˆç®—é€²åº¦æ¢å¯¬åº¦
            document.getElementById('progress-bar').style.width = `${(currentStars / 10) * 100}%`;
        }

        function checkAdminRole(isAdmin) {
            const navGrid = document.getElementById('nav-grid');
            if (isAdmin && !document.getElementById('btn-admin-nav')) {
                navGrid.classList.remove('grid-cols-4');
                navGrid.classList.add('grid-cols-5');
                
                const btn = document.createElement('button');
                btn.id = "btn-admin-nav";
                btn.className = "flex flex-col items-center justify-center hover:bg-slate-700 text-red-400 transition group";
                btn.onclick = () => { loadAdminLogs(); switchToPage('page-admin'); };
                btn.innerHTML = `<i class="fa-solid fa-user-shield mb-1 text-lg"></i><span class="text-[10px]">ç®¡ç†</span>`;
                navGrid.appendChild(btn);
            }
        }

        // 6. æ ¸å¿ƒåŠŸèƒ½ï¼šAI å‡ºé¡Œç³»çµ±
        // 6. æ ¸å¿ƒåŠŸèƒ½ï¼šAI å‡ºé¡Œç³»çµ± (ä¿®æ­£ç‰ˆ)
        window.startQuizFlow = async () => {
            if (!genAI) { alert("ç„¡æ•ˆçš„ API Key"); return; }
            
            switchToPage('page-quiz');
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('quiz-loading').classList.remove('hidden');

            const rankName = RANKS[currentUserData.stats.rankLevel];
            const interests = currentUserData.profile.interests || "ä¸€èˆ¬å¸¸è­˜";

            try {
                // *** ä¿®æ”¹é» 1: æ”¹ç”¨ gemini-1.5-flashï¼Œé€Ÿåº¦å¿«ä¸”æ ¼å¼æº– ***
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash"});
                
                const prompt = `
                    ä½ æ˜¯ä¸€å€‹åš´æ ¼çš„éŠæˆ²å‡ºé¡Œå®˜ã€‚
                    ã€ä»»å‹™ã€‘è«‹æ ¹æ“šç©å®¶èˆˆè¶£"${interests}"èˆ‡ç­‰ç´š"${rankName}"ï¼Œå‡ºä¸€å€‹å–®é¸é¡Œã€‚
                    ã€é‡è¦ã€‘è«‹ç›´æ¥å›å‚³ JSON å­—ä¸²ï¼Œä¸è¦åŒ…å« \`\`\`json æˆ–ä»»ä½•å…¶ä»–æ–‡å­—ã€‚
                    
                    JSON æ ¼å¼ç¯„ä¾‹ï¼š
                    {
                        "q": "é¡Œç›®æ•˜è¿°...",
                        "opts": ["é¸é …A", "é¸é …B", "é¸é …C", "é¸é …D"],
                        "ans": 0 
                    }
                `;

                const result = await model.generateContent(prompt);
                const response = result.response;
                let text = response.text();

                // *** ä¿®æ”¹é» 2: å¼·åŠ›æ¸…æ´—è³‡æ–™ (é˜²æ­¢ AI å¤šå˜´å›å‚³ Markdown) ***
                // æ‰¾å‡ºç¬¬ä¸€å€‹ { å’Œæœ€å¾Œä¸€å€‹ } ä¹‹é–“çš„å…§å®¹
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    text = jsonMatch[0];
                }

                const quizData = JSON.parse(text);

                // æª¢æŸ¥è³‡æ–™æ¬„ä½æ˜¯å¦æ­£ç¢º
                if (!quizData.q || !quizData.opts || quizData.opts.length < 2) {
                    throw new Error("AI å›å‚³æ ¼å¼ç¼ºå°‘æ¬„ä½");
                }

                renderQuiz(quizData, rankName, interests);

            } catch (e) {
                console.error("AI å‡ºé¡Œè©³ç´°éŒ¯èª¤:", e);
                // é¡¯ç¤ºæ›´æ¸…æ¥šçš„éŒ¯èª¤çµ¦ä½ çœ‹
                alert(`å‡ºé¡Œå¤±æ•—ï¼š${e.message}\n(è«‹æŒ‰ F12 é–‹å•Ÿ Console æŸ¥çœ‹è©³ç´°ç´…å­—éŒ¯èª¤)`);
                switchToPage('page-home');
            }
        };

        function renderQuiz(data, rank, topic) {
            document.getElementById('quiz-loading').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            
            document.getElementById('quiz-badge').innerText = `${topic} | ${rank}`;
            document.getElementById('question-text').innerText = data.q;
            
            const container = document.getElementById('options-container');
            container.innerHTML = ''; // æ¸…ç©ºèˆŠé¸é …

            data.opts.forEach((optText, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 bg-slate-700 hover:bg-slate-600 rounded-lg transition border border-slate-600 flex items-center gap-3";
                btn.innerHTML = `<span class="bg-slate-800 w-6 h-6 rounded-full flex items-center justify-center text-xs text-gray-400">${String.fromCharCode(65+idx)}</span> <span>${optText}</span>`;
                btn.onclick = () => handleAnswer(idx, data.ans, data.q);
                container.appendChild(btn);
            });
        }

        // 7. æ ¸å¿ƒåŠŸèƒ½ï¼šçµç®—ç³»çµ±
        async function handleAnswer(userIdx, correctIdx, questionText) {
            const isCorrect = userIdx === correctIdx;
            let { rankLevel, currentStars, totalScore } = currentUserData.stats;
            let msg = "";

            if (isCorrect) {
                currentStars++;
                totalScore += 10 + (rankLevel * 5); // ç­‰ç´šè¶Šé«˜åˆ†è¶Šå¤š
                msg = "âœ… ç­”å°äº†ï¼";
                
                // å‡éšé‚è¼¯
                if (currentStars >= 10) {
                    if (rankLevel < RANKS.length - 1) {
                        rankLevel++;
                        currentStars = 0;
                        msg = `ğŸ‰ æ™‰å‡ï¼æ­å–œä¾†åˆ° ${RANKS[rankLevel]}`;
                    } else {
                        currentStars = 10; // æ»¿ç­‰
                    }
                }
            } else {
                currentStars--;
                msg = "âŒ ç­”éŒ¯äº†...";
                
                // é™éšé‚è¼¯
                if (currentStars < 0) {
                    if (rankLevel > 0) {
                        rankLevel--;
                        currentStars = 8; // é™ç´šä¿è­·
                        msg = `ğŸ’” éºæ†¾é™ç´š... å›åˆ° ${RANKS[rankLevel]}`;
                    } else {
                        currentStars = 0;
                    }
                }
            }

            alert(msg);

            // æ›´æ–°æœ¬åœ°èˆ‡é›²ç«¯
            currentUserData.stats = { rankLevel, currentStars, totalScore };
            
            // å¯«å…¥ User
            updateDoc(doc(db, "users", auth.currentUser.uid), { stats: currentUserData.stats });

            // å¯«å…¥ Log (éåŒæ­¥ï¼Œä¸éœ€ç­‰å¾…)
            addDoc(collection(db, "exam_logs"), {
                uid: auth.currentUser.uid,
                email: auth.currentUser.email,
                question: questionText,
                isCorrect: isCorrect,
                rankAtTime: RANKS[rankLevel],
                timestamp: serverTimestamp()
            });

            updateUIStats();
            switchToPage('page-home');
        }

        // 8. å…¶ä»–åŠŸèƒ½ï¼šè¨­å®šèˆ‡æ’è¡Œ
        window.saveProfile = async () => {
            const val = document.getElementById('input-interests').value;
            await updateDoc(doc(db, "users", auth.currentUser.uid), { "profile.interests": val });
            currentUserData.profile.interests = val;
            alert("è¨­å®šå·²å„²å­˜ï¼ä¸‹é¡Œç”Ÿæ•ˆã€‚");
        };

        window.loadLeaderboard = async () => {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center">è¼‰å…¥ä¸­...</td></tr>';
            
            try {
                const q = query(collection(db, "users"), orderBy("stats.totalScore", "desc"), limit(10));
                const snap = await getDocs(q);
                tbody.innerHTML = '';
                
                let i = 1;
                snap.forEach(doc => {
                    const d = doc.data();
                    const isMe = d.uid === auth.currentUser.uid;
                    const row = `
                        <tr class="border-b border-slate-700 ${isMe ? 'bg-slate-700' : ''}">
                            <td class="px-4 py-3 font-bold ${i===1?'text-yellow-400':''}">${i}</td>
                            <td class="px-4 py-3 flex items-center gap-2">
                                ${i===1 ? '<i class="fa-solid fa-crown text-yellow-500"></i>' : ''}
                                ${d.displayName}
                            </td>
                            <td class="px-4 py-3 text-right font-mono text-blue-300">
                                ${RANKS[d.stats.rankLevel]} <span class="text-xs text-gray-500">(${d.stats.totalScore}åˆ†)</span>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                    i++;
                });
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-red-400 text-center">ç„¡æ³•è®€å–æ’è¡Œæ¦œ (è«‹æª¢æŸ¥ Rules)</td></tr>';
            }
        };

        window.loadAdminLogs = async () => {
            const ul = document.getElementById('admin-logs-list');
            ul.innerHTML = '<li class="text-center py-4">è¼‰å…¥ä¸­...</li>';
            
            const q = query(collection(db, "exam_logs"), orderBy("timestamp", "desc"), limit(30));
            const snap = await getDocs(q);
            
            ul.innerHTML = '';
            snap.forEach(doc => {
                const log = doc.data();
                const time = log.timestamp ? new Date(log.timestamp.toDate()).toLocaleTimeString() : '--:--';
                const statusClass = log.isCorrect ? 'border-green-500 bg-green-900/20' : 'border-red-500 bg-red-900/20';
                
                const li = document.createElement('li');
                li.className = `p-3 rounded text-xs border-l-4 mb-2 ${statusClass}`;
                li.innerHTML = `
                    <div class="flex justify-between mb-1 font-bold">
                        <span>${log.email}</span>
                        <span class="text-gray-400 font-mono">${time}</span>
                    </div>
                    <div class="text-gray-300 mb-2">${log.question}</div>
                    <div class="flex justify-between items-center">
                        <span class="bg-slate-700 px-2 rounded">${log.rankAtTime}</span>
                        <span class="${log.isCorrect ? 'text-green-400' : 'text-red-400'} font-bold">
                            ${log.isCorrect ? 'CORRECT' : 'WRONG'}
                        </span>
                    </div>
                `;
                ul.appendChild(li);
            });
        };
    </script>
</body>
</html>
