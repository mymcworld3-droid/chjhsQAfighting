<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ¯æ—¥å‡éšç­”é¡Œæˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .page-section { display: none; } /* é è¨­éš±è—æ‰€æœ‰é é¢ */
        .active-page { display: block; } /* é¡¯ç¤ºç•¶å‰é é¢ */
        body { background-color: #0f172a; color: white; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pb-safe { padding-bottom: 5rem; }
        
        /* ä¸‹æ‹‰é¸å–®æ¨£å¼å„ªåŒ– */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }
    </style>
</head>
<body class="font-sans h-screen flex flex-col overflow-hidden">

    <header class="p-4 bg-slate-800 shadow-lg flex justify-between items-center z-10 border-b border-slate-700">
        <h1 class="text-xl font-bold text-yellow-400 flex items-center gap-2">
            <i class="fa-solid fa-dragon"></i> å‡éšç­”é¡Œæˆ°
        </h1>
        <div id="user-info" class="text-xs text-gray-300 bg-slate-700 px-3 py-1 rounded-full">æœªç™»å…¥</div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 relative scroll-smooth pb-safe">
        
        <div id="login-screen" class="flex flex-col items-center justify-center h-full">
            <div class="text-center mb-8 animate-bounce">
                <i class="fa-solid fa-crown text-6xl text-yellow-500 mb-4"></i>
            </div>
            <h2 class="text-3xl font-bold mb-2">æ­¡è¿æŒ‘æˆ°</h2>
            <p class="text-gray-400 mb-8 text-sm">AI å‡ºé¡Œ x å®¢è£½åŒ–å­¸ç¿’ x å…¨æœæ’è¡Œ</p>
            
            <button onclick="googleLogin()" class="bg-white text-gray-800 hover:bg-gray-100 px-8 py-3 rounded-full font-bold shadow-lg transition flex items-center gap-2 transform hover:scale-105">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                ä½¿ç”¨ Google ç™»å…¥
            </button>
        </div>

        <div id="page-onboarding" class="page-section hidden absolute top-0 left-0 w-full h-full bg-slate-900 z-50 p-6 overflow-y-auto">
            <div class="max-w-md mx-auto mt-10">
                <h2 class="text-2xl font-bold text-blue-400 mb-2">ğŸ‘‹ å—¨ï¼åˆæ¬¡è¦‹é¢</h2>
                <p class="text-gray-400 mb-6">ç‚ºäº†è®“ AI å‡ºæ›´é©åˆä½ çš„é¡Œç›®ï¼Œè«‹å‘Šè¨´æˆ‘é—œæ–¼ä½ çš„è³‡è¨Šï¼š</p>

                <div class="space-y-6">
                    <div>
                        <label class="block mb-2 text-sm font-bold text-white">ä½ æ˜¯å¹¾å¹´ç´šå­¸ç”Ÿï¼Ÿ</label>
                        <select id="ob-level" class="w-full bg-slate-800 border border-slate-600 text-white rounded-lg p-3 outline-none focus:border-blue-500">
                            <option value="åœ‹å°ä½å¹´ç´š">åœ‹å° (ä½å¹´ç´š)</option>
                            <option value="åœ‹å°ä¸­å¹´ç´š">åœ‹å° (ä¸­å¹´ç´š)</option>
                            <option value="åœ‹å°é«˜å¹´ç´š">åœ‹å° (é«˜å¹´ç´š)</option>
                            <option value="åœ‹ä¸­ä¸€å¹´ç´š">åœ‹ä¸­ (ä¸€å¹´ç´š)</option>
                            <option value="åœ‹ä¸­äºŒå¹´ç´š">åœ‹ä¸­ (äºŒå¹´ç´š)</option>
                            <option value="åœ‹ä¸­ä¸‰å¹´ç´š">åœ‹ä¸­ (ä¸‰å¹´ç´š)</option>
                            <option value="é«˜ä¸­è·">é«˜ä¸­ / é«˜è·</option>
                            <option value="å¤§å­¸ä»¥ä¸Š">å¤§å­¸ / ç¤¾æœƒäººå£«</option>
                        </select>
                    </div>

                    <div>
                        <label class="block mb-2 text-sm font-bold text-green-400">ä½ æ“…é•·çš„ç§‘ç›® (æˆ–èˆˆè¶£)ï¼Ÿ</label>
                        <input type="text" id="ob-strong" class="w-full bg-slate-800 border border-slate-600 text-white rounded-lg p-3 outline-none focus:border-green-500" placeholder="ä¾‹å¦‚ï¼šæ­·å², è‹±æ–‡, å‹•æ¼«çŸ¥è­˜">
                    </div>

                    <div>
                        <label class="block mb-2 text-sm font-bold text-red-400">ä½ æƒ³åŠ å¼·çš„å¼±é …ç§‘ç›®ï¼Ÿ</label>
                        <input type="text" id="ob-weak" class="w-full bg-slate-800 border border-slate-600 text-white rounded-lg p-3 outline-none focus:border-red-500" placeholder="ä¾‹å¦‚ï¼šæ•¸å­¸, ç†åŒ–">
                    </div>

                    <button onclick="submitOnboarding()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg transform active:scale-95 transition">
                        é–‹å§‹æˆ‘çš„æ—…ç¨‹ ğŸš€
                    </button>
                </div>
            </div>
        </div>

        <div id="page-home" class="page-section hidden">
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-8 rounded-2xl shadow-xl text-center border border-slate-700 relative overflow-hidden">
                <i class="fa-solid fa-trophy absolute -bottom-4 -right-4 text-9xl text-white opacity-5 transform rotate-12"></i>
                
                <div class="text-gray-400 text-xs uppercase tracking-widest mb-2">Current Rank</div>
                <h2 class="text-5xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-orange-400 to-red-500" id="display-rank">è¼‰å…¥ä¸­</h2>
                
                <div class="flex justify-center items-center gap-2 mt-6 text-gray-300 bg-slate-800/50 inline-block px-4 py-1 rounded-full">
                    <i class="fa-solid fa-star text-yellow-400"></i>
                    <span>éšæ®µ: <span id="display-stars" class="font-bold text-white text-lg">0</span> / 10</span>
                </div>

                <div class="w-full bg-slate-950 rounded-full h-3 mt-6 overflow-hidden border border-slate-700">
                    <div id="progress-bar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                </div>

                <button onclick="startQuizFlow()" class="mt-8 bg-blue-600 w-full py-4 rounded-xl text-xl font-bold hover:bg-blue-500 shadow-lg shadow-blue-900/50 transform active:scale-95 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-play"></i> é–‹å§‹æŒ‘æˆ°
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-4">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <div class="text-xs text-gray-400">ç¸½ç©åˆ†</div>
                    <div class="text-2xl font-bold text-white" id="display-score">0</div>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <div class="text-xs text-gray-400">é€£å‹ç´€éŒ„</div>
                    <div class="text-2xl font-bold text-green-400">--</div>
                </div>
            </div>
        </div>

        <div id="page-quiz" class="page-section hidden">
            <div id="quiz-loading" class="text-center mt-32 hidden">
                <div class="loader"></div>
                <h3 class="text-xl font-bold mt-4 text-blue-300">é›²ç«¯å¤§è…¦é‹ç®—ä¸­</h3>
                <p class="text-xs text-gray-500 mt-2" id="loading-text">æ­£åœ¨æ ¹æ“šæ‚¨çš„å¼±é …ç”Ÿæˆé¡Œç›®...</p>
            </div>

            <div id="quiz-container" class="hidden">
                <div class="bg-slate-800 p-6 rounded-xl mb-6 border-t-4 border-blue-500 shadow-lg relative">
                    <span class="absolute top-4 right-4 bg-slate-900 text-xs px-2 py-1 rounded text-gray-400" id="quiz-badge">ä¸»é¡Œ | ç­‰ç´š</span>
                    <div class="text-4xl text-blue-500/20 absolute top-2 left-2"><i class="fa-solid fa-quote-left"></i></div>
                    <h3 class="text-lg font-bold leading-relaxed mt-4 relative z-10" id="question-text">é¡Œç›®è¼‰å…¥ä¸­...</h3>
                </div>

                <div id="options-container" class="space-y-3">
                    </div>
                
                <button onclick="switchToPage('page-home')" class="mt-8 py-3 text-gray-500 text-sm w-full text-center hover:text-white border border-transparent hover:border-slate-700 rounded-lg transition">
                    <i class="fa-solid fa-arrow-left"></i> æ”¾æ£„ä¸¦è¿”å›é¦–é 
                </button>
            </div>
        </div>

        <div id="page-history" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-purple-400">
                <i class="fa-solid fa-clock-rotate-left"></i> æˆ‘çš„ç­”é¡Œç´€éŒ„
            </h2>
            <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 h-[75vh] flex flex-col shadow-2xl">
                <div class="p-3 bg-slate-900 border-b border-slate-700 font-bold text-xs text-gray-400 uppercase tracking-wider flex justify-between">
                    <span>å€‹äººå­¸ç¿’æ­·ç¨‹</span>
                    <button onclick="loadUserHistory()" class="text-blue-400 hover:text-white transition"><i class="fa-solid fa-rotate"></i></button>
                </div>
                <ul id="history-list" class="overflow-y-auto p-2 space-y-2 flex-1 text-sm scrollbar-thin scrollbar-thumb-slate-600">
                    <li class="text-center text-gray-500 py-10">è¼‰å…¥ä¸­...</li>
                </ul>
            </div>
        </div>

        <div id="page-rank" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-yellow-400">
                <i class="fa-solid fa-trophy"></i> å…¨æœæ’è¡Œæ¦œ
            </h2>
            <div class="bg-slate-800 rounded-xl overflow-hidden shadow-lg border border-slate-700">
                <table class="w-full text-left text-sm text-gray-300">
                    <thead class="bg-slate-900 text-gray-400 uppercase text-xs">
                        <tr>
                            <th class="px-4 py-3 w-12">#</th>
                            <th class="px-4 py-3">ç©å®¶</th>
                            <th class="px-4 py-3 text-right">æ®µä½</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="page-settings" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-4">âš™ï¸ å€‹äººè¨­å®š</h2>
            
            <div class="bg-slate-800 p-6 rounded-xl shadow-lg mb-6 border border-slate-700 space-y-4">
                
                <div>
                    <label class="block mb-1 text-sm font-bold text-white">å¹´ç´š / èº«ä»½</label>
                    <select id="set-level" class="w-full bg-slate-900 border border-slate-600 text-white rounded-lg p-3">
                        <option value="åœ‹å°ä½å¹´ç´š">åœ‹å° (ä½å¹´ç´š)</option>
                        <option value="åœ‹å°ä¸­å¹´ç´š">åœ‹å° (ä¸­å¹´ç´š)</option>
                        <option value="åœ‹å°é«˜å¹´ç´š">åœ‹å° (é«˜å¹´ç´š)</option>
                        <option value="åœ‹ä¸­ä¸€å¹´ç´š">åœ‹ä¸­ (ä¸€å¹´ç´š)</option>
                        <option value="åœ‹ä¸­äºŒå¹´ç´š">åœ‹ä¸­ (äºŒå¹´ç´š)</option>
                        <option value="åœ‹ä¸­ä¸‰å¹´ç´š">åœ‹ä¸­ (ä¸‰å¹´ç´š)</option>
                        <option value="é«˜ä¸­è·">é«˜ä¸­ / é«˜è·</option>
                        <option value="å¤§å­¸ä»¥ä¸Š">å¤§å­¸ / ç¤¾æœƒäººå£«</option>
                    </select>
                </div>

                <div>
                    <label class="block mb-1 text-sm font-bold text-green-400">æ“…é•·ç§‘ç›®</label>
                    <input type="text" id="set-strong" class="bg-slate-900 border border-slate-600 text-white text-sm rounded-lg w-full p-3" placeholder="ä¾‹å¦‚ï¼šæ­·å²">
                </div>

                <div>
                    <label class="block mb-1 text-sm font-bold text-red-400">å¼±é … (åŠ å¼·ç·´ç¿’)</label>
                    <input type="text" id="set-weak" class="bg-slate-900 border border-slate-600 text-white text-sm rounded-lg w-full p-3" placeholder="ä¾‹å¦‚ï¼šæ•¸å­¸">
                </div>

                <button onclick="saveProfile()" class="mt-2 bg-blue-600 text-white px-4 py-3 rounded-lg w-full font-bold hover:bg-blue-500 transition shadow-lg">
                    æ›´æ–°è¨­å®š
                </button>
            </div>

            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 mb-6">
                <div class="text-xs text-gray-400 mb-1">å¸³è™Ÿ</div>
                <div class="text-sm font-mono text-white truncate" id="settings-email">checking...</div>
            </div>

            <button onclick="logout()" class="bg-red-900/30 border border-red-800/50 text-red-300 px-4 py-3 rounded-lg w-full hover:bg-red-900/50 transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-right-from-bracket"></i> ç™»å‡ºå¸³è™Ÿ
            </button>
        </div>

        <div id="page-admin" class="page-section hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-red-400 flex items-center gap-2">
                    <i class="fa-solid fa-shield-halved"></i> ç®¡ç†å¾Œå° (å…¨æœ)
                </h2>
                <button onclick="loadAdminLogs()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded transition">
                    <i class="fa-solid fa-rotate"></i> åˆ·æ–°
                </button>
            </div>
            
            <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 h-[75vh] flex flex-col shadow-2xl">
                <div class="p-3 bg-slate-900 border-b border-slate-700 font-bold text-xs text-gray-400 uppercase tracking-wider">
                    å³æ™‚ç­”é¡Œç›£æ§æ—¥èªŒ
                </div>
                <ul id="admin-logs-list" class="overflow-y-auto p-2 space-y-2 flex-1 text-sm scrollbar-thin scrollbar-thumb-slate-600">
                    <li class="text-center text-gray-500 py-10">é»æ“Šå³ä¸Šè§’åˆ·æ–°è¼‰å…¥æ•¸æ“š...</li>
                </ul>
            </div>
        </div>

    </main>

    <nav id="bottom-nav" class="bg-slate-800/90 backdrop-blur-md border-t border-slate-700 fixed bottom-0 w-full z-50 hidden transition-all duration-300">
        <div class="grid h-16 grid-cols-5 mx-auto font-medium" id="nav-grid">
            
            <button onclick="switchToPage('page-home')" class="flex flex-col items-center justify-center hover:bg-white/5 text-gray-400 hover:text-white transition group active-nav-btn" data-target="page-home">
                <i class="fa-solid fa-house mb-1 text-lg group-hover:text-blue-400 transition-colors"></i>
                <span class="text-[10px]">é¦–é </span>
            </button>
            
            <button onclick="startQuizFlow()" class="flex flex-col items-center justify-center hover:bg-white/5 text-gray-400 hover:text-white transition group" data-target="page-quiz">
                <i class="fa-solid fa-swords mb-1 text-lg group-hover:text-red-400 transition-colors"></i>
                <span class="text-[10px]">ç­”é¡Œ</span>
            </button>
            
            <button onclick="loadUserHistory(); switchToPage('page-history')" class="flex flex-col items-center justify-center hover:bg-white/5 text-gray-400 hover:text-white transition group" data-target="page-history">
                <i class="fa-solid fa-clock-rotate-left mb-1 text-lg group-hover:text-purple-400 transition-colors"></i>
                <span class="text-[10px]">ç´€éŒ„</span>
            </button>

            <button onclick="loadLeaderboard(); switchToPage('page-rank')" class="flex flex-col items-center justify-center hover:bg-white/5 text-gray-400 hover:text-white transition group" data-target="page-rank">
                <i class="fa-solid fa-chart-simple mb-1 text-lg group-hover:text-yellow-400 transition-colors"></i>
                <span class="text-[10px]">æ’è¡Œ</span>
            </button>
            
            <button onclick="switchToPage('page-settings')" class="flex flex-col items-center justify-center hover:bg-white/5 text-gray-400 hover:text-white transition group" data-target="page-settings">
                <i class="fa-solid fa-user-gear mb-1 text-lg group-hover:text-green-400 transition-colors"></i>
                <span class="text-[10px]">è¨­å®š</span>
            </button>

        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config (è«‹ç¢ºä¿é€™è·Ÿä¹‹å‰ä¸€æ¨£)
        const firebaseConfig = {
            apiKey: "AIzaSyDifdJmLTmwQATz__xUHSkXZ_xXOWyX-wU",
            authDomain: "question-learning.firebaseapp.com",
            projectId: "question-learning",
            storageBucket: "question-learning.firebasestorage.app",
            messagingSenderId: "1058543232092",
            appId: "1:1058543232092:web:3fcc40f5f069b6df307299",
            measurementId: "G-76ER8RGBN7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();
        const provider = new GoogleAuthProvider();
        
        let currentUserData = null;
        const RANKS = ["ğŸ¥‰ é’éŠ…", "ğŸ¥ˆ ç™½éŠ€", "ğŸ¥‡ é»ƒé‡‘", "ğŸ’ é‰‘é‡‘", "ğŸ”· é‘½çŸ³", "ğŸŒŸ æ˜Ÿè€€"];

        // ç™»å…¥
        window.googleLogin = () => {
            signInWithPopup(auth, provider).catch((error) => alert("ç™»å…¥å¤±æ•—: " + error.code));
        };

        window.logout = () => {
            signOut(auth).then(() => location.reload());
        };

        // ç›£è½ç™»å…¥ç‹€æ…‹
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('bottom-nav').classList.remove('hidden');
                document.getElementById('user-info').innerHTML = `<i class="fa-solid fa-user-astronaut"></i> ${user.displayName}`;
                document.getElementById('settings-email').innerText = user.email;

                const userRef = doc(db, "users", user.uid);
                try {
                    const docSnap = await getDoc(userRef);
                    
                    if (docSnap.exists()) {
                        currentUserData = docSnap.data();
                    } else {
                        // åˆå§‹åŒ–è³‡æ–™
                        currentUserData = {
                            uid: user.uid,
                            displayName: user.displayName,
                            email: user.email,
                            profile: { 
                                educationLevel: "", // æ–°æ¬„ä½
                                strongSubjects: "", // æ–°æ¬„ä½
                                weakSubjects: ""    // æ–°æ¬„ä½
                            },
                            stats: { rankLevel: 0, currentStars: 0, totalScore: 0 },
                            isAdmin: false
                        };
                        await setDoc(userRef, currentUserData);
                    }
                    
                    // å¡«å……è¨­å®šé é¢çš„å€¼
                    updateSettingsInputs();

                    // æª¢æŸ¥ç®¡ç†å“¡
                    checkAdminRole(currentUserData.isAdmin);

                    // æª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºã€Œæ–°æ‰‹å¼•å°ã€ (å¦‚æœæ²’æœ‰å¹´ç´šè³‡æ–™)
                    if (!currentUserData.profile?.educationLevel) {
                        switchToPage('page-onboarding');
                    } else {
                        updateUIStats();
                        switchToPage('page-home');
                    }

                } catch (error) {
                    console.error(error);
                    alert("è³‡æ–™è®€å–éŒ¯èª¤");
                }
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('bottom-nav').classList.add('hidden');
            }
        });

        // é é¢åˆ‡æ›
        window.switchToPage = (pageId) => {
            document.querySelectorAll('.page-section').forEach(el => {
                el.classList.remove('active-page', 'hidden');
                el.classList.add('hidden');
            });
            const target = document.getElementById(pageId);
            if(target) {
                target.classList.remove('hidden');
                target.classList.add('active-page');
            }
            
            // æ›´æ–°å°èˆªæŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('#nav-grid button').forEach(btn => {
                if (btn.dataset.target === pageId) {
                    btn.classList.add('text-white');
                    btn.classList.remove('text-gray-400');
                } else {
                    btn.classList.remove('text-white');
                    btn.classList.add('text-gray-400');
                }
            });
        };

        function updateUIStats() {
            if(!currentUserData) return;
            const { rankLevel, currentStars, totalScore } = currentUserData.stats;
            document.getElementById('display-rank').innerText = RANKS[rankLevel] || "æœªçŸ¥";
            document.getElementById('display-stars').innerText = currentStars;
            document.getElementById('display-score').innerText = totalScore;
            setTimeout(() => {
                document.getElementById('progress-bar').style.width = `${(currentStars / 10) * 100}%`;
            }, 100);
        }

        function updateSettingsInputs() {
            if (currentUserData && currentUserData.profile) {
                document.getElementById('set-level').value = currentUserData.profile.educationLevel || "åœ‹ä¸­ä¸€å¹´ç´š";
                document.getElementById('set-strong').value = currentUserData.profile.strongSubjects || "";
                document.getElementById('set-weak').value = currentUserData.profile.weakSubjects || "";
            }
        }

        // æ–°æ‰‹å¼•å°æäº¤
        window.submitOnboarding = async () => {
            const level = document.getElementById('ob-level').value;
            const strong = document.getElementById('ob-strong').value;
            const weak = document.getElementById('ob-weak').value;

            if(!level) { alert("è«‹é¸æ“‡å¹´ç´š"); return; }

            const btn = document.querySelector('button[onclick="submitOnboarding()"]');
            btn.innerText = "è³‡æ–™å»ºç«‹ä¸­...";
            
            // æ›´æ–°è³‡æ–™åº«
            await updateDoc(doc(db, "users", auth.currentUser.uid), {
                "profile.educationLevel": level,
                "profile.strongSubjects": strong,
                "profile.weakSubjects": weak
            });

            // æ›´æ–°æœ¬åœ°è®Šæ•¸
            currentUserData.profile.educationLevel = level;
            currentUserData.profile.strongSubjects = strong;
            currentUserData.profile.weakSubjects = weak;

            // åŒæ­¥æ›´æ–°è¨­å®šé é¢
            updateSettingsInputs();

            updateUIStats();
            switchToPage('page-home');
        };

        // è¨­å®šé é¢ä¿å­˜
        window.saveProfile = async () => {
            const level = document.getElementById('set-level').value;
            const strong = document.getElementById('set-strong').value;
            const weak = document.getElementById('set-weak').value;

            const btn = document.querySelector('button[onclick="saveProfile()"]');
            btn.innerText = "å„²å­˜ä¸­...";

            await updateDoc(doc(db, "users", auth.currentUser.uid), {
                "profile.educationLevel": level,
                "profile.strongSubjects": strong,
                "profile.weakSubjects": weak
            });

            currentUserData.profile.educationLevel = level;
            currentUserData.profile.strongSubjects = strong;
            currentUserData.profile.weakSubjects = weak;
            
            btn.innerText = "å„²å­˜æˆåŠŸ";
            setTimeout(() => btn.innerText = "æ›´æ–°è¨­å®š", 2000);
        };

        function checkAdminRole(isAdmin) {
            const navGrid = document.getElementById('nav-grid');
            if (isAdmin && !document.getElementById('btn-admin-nav')) {
                // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼ŒæŠŠ Grid è®Šæˆ 6 æ¬„
                navGrid.classList.remove('grid-cols-5');
                navGrid.classList.add('grid-cols-6');
                
                const btn = document.createElement('button');
                btn.id = "btn-admin-nav";
                btn.dataset.target = "page-admin";
                btn.className = "flex flex-col items-center justify-center hover:bg-white/5 text-gray-400 hover:text-red-400 transition group";
                btn.onclick = () => { loadAdminLogs(); switchToPage('page-admin'); };
                btn.innerHTML = `
                    <i class="fa-solid fa-user-shield mb-1 text-lg group-hover:text-red-400 transition-colors"></i>
                    <span class="text-[10px]">ç®¡ç†</span>
                `;
                navGrid.appendChild(btn);
            }
        }

        // ==========================================
        //  AI å‡ºé¡Œ (å·²æ•´åˆå€‹äººè³‡æ–™)
        // ==========================================
        window.startQuizFlow = async () => {
            const BACKEND_URL = "/api/generate-quiz";

            // æª¢æŸ¥ç¶²å€æœ‰æ²’æœ‰æ”¹
            if(BACKEND_URL.includes("ä½ çš„å°ˆæ¡ˆåç¨±")) {
                alert("è«‹ä¿®æ”¹ç¨‹å¼ç¢¼ä¸­çš„ BACKEND_URL ç‚ºä½ çš„ Render ç¶²å€ï¼");
                return;
            }

            switchToPage('page-quiz');
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('quiz-loading').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "AI æ­£åœ¨åˆ†ææ‚¨çš„å¼±é …ä¸¦å‡ºé¡Œ...";

            const rankName = RANKS[currentUserData.stats.rankLevel];
            
            // å–å‡ºå€‹äººè³‡æ–™
            const level = currentUserData.profile.educationLevel || "ä¸€èˆ¬";
            const strong = currentUserData.profile.strongSubjects || "ç„¡";
            const weak = currentUserData.profile.weakSubjects || "ç„¡";

            // Prompt æ•´åˆæ‰€æœ‰è³‡è¨Š
            const promptText = `
                ä½ æ˜¯ä¸€å€‹å°ˆæ¥­å®¶æ•™èˆ‡éŠæˆ²å‡ºé¡Œå®˜ã€‚
                ç©å®¶è³‡æ–™ï¼š
                - å¹´ç´šç¨‹åº¦ï¼š${level}
                - éŠæˆ²æ®µä½ï¼š${rankName}
                - æ“…é•·ç§‘ç›®ï¼š${strong}
                - å¼±é …ç§‘ç›®ï¼š${weak}

                ä»»å‹™ï¼šè«‹å„ªå…ˆé‡å°ç©å®¶çš„ã€Œå¼±é …ç§‘ç›®ã€å‡ºé¡Œï¼Œå¦‚æœå¼±é …ä¸æ˜ç¢ºå‰‡æ··åˆå‡ºé¡Œã€‚é›£åº¦è«‹ç¬¦åˆã€Œå¹´ç´šç¨‹åº¦ã€èˆ‡ã€ŒéŠæˆ²æ®µä½ã€ã€‚
                
                è¦æ±‚ï¼šåªå›å‚³ç´” JSON å­—ä¸²ï¼Œä¸è¦ Markdownã€‚
                æ ¼å¼ç¯„ä¾‹ï¼š
                {
                    "q": "é¡Œç›®å…§å®¹...",
                    "opts": ["Aé¸é …", "Bé¸é …", "Cé¸é …", "Dé¸é …"],
                    "ans": 0 
                }
                (ans: 0=A, 1=B...)
            `;

            try {
                const response = await fetch(BACKEND_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ prompt: promptText })
                });

                if (!response.ok) throw new Error(`Server Error: ${response.status}`);

                const data = await response.json();
                let aiText = data.text;
                const jsonMatch = aiText.match(/\{[\s\S]*\}/);
                if (jsonMatch) aiText = jsonMatch[0];

                const quizData = JSON.parse(aiText);

                if (!quizData.q || !quizData.opts) throw new Error("JSON æ ¼å¼æå£");

                // åœ¨ç•«é¢ä¸Šé¡¯ç¤ºé€™é¡Œæ˜¯é‡å°ä»€éº¼å‡ºçš„ (ç°¡å–®åˆ¤æ–·)
                let badgeText = weak !== "ç„¡" ? `åŠ å¼·ç·´ç¿’: ${weak}` : "ç¶œåˆæ¸¬é©—";
                renderQuiz(quizData, rankName, badgeText);

            } catch (e) {
                console.error("Quiz Error:", e);
                alert(`å‡ºé¡Œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\nåŸå› : ${e.message}`);
                switchToPage('page-home');
            }
        };

        function renderQuiz(data, rank, topic) {
            document.getElementById('quiz-loading').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            document.getElementById('quiz-badge').innerText = `${topic} | ${rank}`;
            document.getElementById('question-text').innerText = data.q;
            
            const container = document.getElementById('options-container');
            container.innerHTML = ''; 
            data.opts.forEach((optText, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 bg-slate-700 hover:bg-slate-600 rounded-lg transition border border-slate-600 flex items-center gap-3 active:scale-95";
                btn.innerHTML = `
                    <span class="bg-slate-800 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-blue-400 border border-slate-600">${String.fromCharCode(65+idx)}</span> 
                    <span class="flex-1">${optText}</span>
                `;
                btn.onclick = () => handleAnswer(idx, data.ans, data.q);
                container.appendChild(btn);
            });
        }

        async function handleAnswer(userIdx, correctIdx, questionText) {
            const isCorrect = userIdx === correctIdx;
            let { rankLevel, currentStars, totalScore } = currentUserData.stats;
            
            if (navigator.vibrate) navigator.vibrate(isCorrect ? 50 : 200);

            if (isCorrect) {
                currentStars++;
                totalScore += 10 + (rankLevel * 5); 
                alert("âœ… ç­”å°äº†ï¼");
                if (currentStars >= 10) {
                    if (rankLevel < RANKS.length - 1) {
                        rankLevel++;
                        currentStars = 0;
                        alert(`ğŸ‰ æ­å–œæ™‰å‡ï¼ä¾†åˆ° ${RANKS[rankLevel]}`);
                    } else {
                        currentStars = 10;
                    }
                }
            } else {
                currentStars--;
                alert("âŒ ç­”éŒ¯äº†...");
                if (currentStars < 0) {
                    if (rankLevel > 0) {
                        rankLevel--;
                        currentStars = 8;
                        alert(`ğŸ’” é™ç´š... é€€å› ${RANKS[rankLevel]}`);
                    } else {
                        currentStars = 0;
                    }
                }
            }

            currentUserData.stats = { rankLevel, currentStars, totalScore };
            updateDoc(doc(db, "users", auth.currentUser.uid), { stats: currentUserData.stats });

            addDoc(collection(db, "exam_logs"), {
                uid: auth.currentUser.uid,
                email: auth.currentUser.email,
                question: questionText,
                isCorrect: isCorrect,
                rankAtTime: RANKS[rankLevel],
                timestamp: serverTimestamp()
            }).catch(e => console.error("Log error:", e));

            updateUIStats();
            switchToPage('page-home');
        }

        // ==========================================
        //  æ­·å²ç´€éŒ„ (å€‹äºº vs ç®¡ç†å“¡)
        // ==========================================
        
        // 1. è¼‰å…¥ã€Œå€‹äººã€æ­·å²ç´€éŒ„ (åªçœ‹è‡ªå·±çš„)
        window.loadUserHistory = async () => {
            const ul = document.getElementById('history-list');
            ul.innerHTML = '<li class="text-center py-10"><div class="loader"></div></li>';
            
            try {
                // æŸ¥è©¢æ¢ä»¶ï¼šuid æ˜¯è‡ªå·±ï¼Œä¸”æŒ‰ç…§æ™‚é–“æ’åº
                // âš ï¸ æ³¨æ„ï¼šç¬¬ä¸€æ¬¡åŸ·è¡Œå¯èƒ½æœƒåœ¨ Console çœ‹åˆ°ç´…è‰²éŒ¯èª¤è¦æ±‚å»ºç«‹ç´¢å¼•ï¼Œè«‹é»æ“Šé€£çµå»ºç«‹
                const q = query(
                    collection(db, "exam_logs"), 
                    where("uid", "==", auth.currentUser.uid),
                    orderBy("timestamp", "desc"), 
                    limit(20)
                );
                
                const snap = await getDocs(q);
                ul.innerHTML = '';
                
                if (snap.empty) {
                    ul.innerHTML = '<li class="text-center text-gray-500 py-10">é‚„æ²’æœ‰ç­”é¡Œç´€éŒ„ï¼Œå¿«å»æŒ‘æˆ°å§ï¼</li>';
                    return;
                }

                snap.forEach(doc => {
                    const log = doc.data();
                    const time = log.timestamp ? new Date(log.timestamp.toDate()).toLocaleString() : '--';
                    
                    const li = document.createElement('li');
                    li.className = `p-3 rounded-lg text-xs border-l-4 mb-2 bg-slate-700/50 ${log.isCorrect ? 'border-green-500' : 'border-red-500'}`;
                    li.innerHTML = `
                        <div class="flex justify-between mb-1">
                            <span class="text-gray-400 font-mono">${time}</span>
                            <span class="${log.isCorrect ? 'text-green-400' : 'text-red-400'} font-bold">
                                ${log.isCorrect ? 'ç­”å°' : 'ç­”éŒ¯'}
                            </span>
                        </div>
                        <div class="text-white mb-2 text-sm">${log.question}</div>
                        <div class="text-gray-500 text-right">ç•¶æ™‚æ®µä½: ${log.rankAtTime}</div>
                    `;
                    ul.appendChild(li);
                });

            } catch (e) {
                console.error(e);
                if(e.message.includes("requires an index")) {
                    ul.innerHTML = '<li class="text-center text-yellow-400 py-4 p-4">âš ï¸ é–‹ç™¼è€…è«‹æ³¨æ„ï¼š<br>Firebase éœ€è¦å»ºç«‹è¤‡åˆç´¢å¼•æ‰èƒ½é€²è¡Œæ­¤æŸ¥è©¢ã€‚<br>è«‹æ‰“é–‹ç€è¦½å™¨ Console (F12) é»æ“Šé€£çµå»ºç«‹ç´¢å¼•ã€‚</li>';
                } else {
                    ul.innerHTML = '<li class="text-center text-red-400 py-4">è®€å–å¤±æ•—</li>';
                }
            }
        };

        // 2. è¼‰å…¥ã€Œç®¡ç†å“¡ã€ç›£æ§æ—¥èªŒ (çœ‹æ‰€æœ‰äººçš„)
        window.loadAdminLogs = async () => {
            const ul = document.getElementById('admin-logs-list');
            ul.innerHTML = '<li class="text-center py-10"><div class="loader"></div></li>';
            
            try {
                const q = query(collection(db, "exam_logs"), orderBy("timestamp", "desc"), limit(30));
                const snap = await getDocs(q);
                
                ul.innerHTML = '';
                snap.forEach(doc => {
                    const log = doc.data();
                    const time = log.timestamp ? new Date(log.timestamp.toDate()).toLocaleTimeString() : '--:--';
                    
                    const li = document.createElement('li');
                    li.className = `p-3 rounded-lg text-xs border-l-4 mb-2 bg-slate-700/50 ${log.isCorrect ? 'border-green-500' : 'border-red-500'}`;
                    li.innerHTML = `
                        <div class="flex justify-between mb-1">
                            <span class="font-bold text-gray-300 truncate w-2/3">${log.email}</span>
                            <span class="text-gray-500 font-mono">${time}</span>
                        </div>
                        <div class="text-gray-400 mb-2 line-clamp-2">${log.question}</div>
                        <div class="flex justify-between items-center bg-slate-900/50 p-1 rounded">
                            <span class="text-gray-400">${log.rankAtTime}</span>
                            <span class="${log.isCorrect ? 'text-green-400' : 'text-red-400'} font-bold px-2 py-0.5 rounded">
                                ${log.isCorrect ? 'CORRECT' : 'WRONG'}
                            </span>
                        </div>
                    `;
                    ul.appendChild(li);
                });
            } catch (e) {
                ul.innerHTML = '<li class="text-center text-red-400 py-4">è®€å–å¤±æ•— (æ¬Šé™ä¸è¶³)</li>';
            }
        };

        window.loadLeaderboard = async () => {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-500"><div class="loader"></div></td></tr>';
            
            try {
                const q = query(collection(db, "users"), orderBy("stats.totalScore", "desc"), limit(10));
                const snap = await getDocs(q);
                tbody.innerHTML = '';
                
                let i = 1;
                snap.forEach(doc => {
                    const d = doc.data();
                    const isMe = auth.currentUser && d.uid === auth.currentUser.uid;
                    const row = `
                        <tr class="border-b border-slate-700/50 ${isMe ? 'bg-blue-900/20' : ''} hover:bg-slate-700/50 transition">
                            <td class="px-4 py-4 font-bold ${i===1?'text-yellow-400':(i===2?'text-gray-300':(i===3?'text-orange-400':'text-gray-500'))}">${i}</td>
                            <td class="px-4 py-4 flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-slate-700 flex items-center justify-center text-xs text-gray-400">
                                    <i class="fa-solid fa-user"></i>
                                </div>
                                <span class="${isMe ? 'text-blue-300 font-bold' : ''}">${d.displayName}</span>
                            </td>
                            <td class="px-4 py-4 text-right font-mono text-blue-300">
                                ${RANKS[d.stats.rankLevel] || "é’éŠ…"} 
                                <span class="text-xs text-gray-500 block">${d.stats.totalScore} pts</span>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                    i++;
                });
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-red-400 text-center">ç„¡æ³•è®€å–æ’è¡Œæ¦œ</td></tr>';
            }
        };
    </script>
</body>
</html>
