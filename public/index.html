<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ¯æ—¥å‡éšç­”é¡Œæˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .page-section { display: none; }
        .active-page { display: block; }
        body { background-color: #0f172a; color: white; }
        
        /* è¼‰å…¥å‹•ç•« */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* é›·é”èˆ‡ç•™ç™½ */
        .radar-scan {
            width: 100px; height: 100px;
            background: radial-gradient(circle, rgba(59,130,246,0) 0%, rgba(59,130,246,0.2) 100%);
            border: 2px solid #3b82f6;
            border-radius: 50%;
            position: relative;
            animation: pulse 2s infinite;
        }
        .radar-line {
            width: 50%; height: 2px; background: #3b82f6;
            position: absolute; top: 50%; left: 50%;
            transform-origin: 0 0;
            animation: radar 2s linear infinite;
        }
        @keyframes radar { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        
        /* â­ é—œéµä¿®æ”¹ï¼šå…¨é é¢åº•éƒ¨ç•™ç™½ 10rem */
        .pb-safe { padding-bottom: 10rem !important; }
        
        select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em;
        }
        
        .btn-correct { background-color: #22c55e !important; border-color: #22c55e !important; color: white !important; }
        .btn-wrong { background-color: #ef4444 !important; border-color: #ef4444 !important; color: white !important; }
        .btn-disabled { opacity: 0.6; pointer-events: none; }
        .nav-locked { opacity: 0.3; pointer-events: none; filter: grayscale(100%); transition: all 0.3s; }

        /* â­ é ­åƒèˆ‡æ¡†çš„ç–ŠåŠ æ¨£å¼ */
        .avatar-container { position: relative; display: inline-block; }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .avatar-frame { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; object-fit: contain; transform: scale(1.15); } 
    </style>
</head>
<body class="font-sans h-[100dvh] flex flex-col overflow-hidden">

    <header class="p-4 bg-slate-800 shadow-lg flex justify-between items-center z-10 border-b border-slate-700">
        <h1 class="text-xl font-bold text-yellow-400 flex items-center gap-2">
            <i class="fa-solid fa-dragon"></i> å‡éšç­”é¡Œæˆ°
        </h1>
        <div class="flex items-center gap-2 bg-slate-700/50 px-3 py-1 rounded-full border border-slate-600">
            <div class="avatar-container w-6 h-6">
                <img id="header-avatar" src="https://api.dicebear.com/7.x/adventurer/svg?seed=Felix" class="avatar-img">
                <img id="header-frame" src="" class="avatar-frame hidden">
            </div>
            <div id="user-info" class="text-xs text-gray-300">æœªç™»å…¥</div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 relative scroll-smooth pb-safe">
        
        <div id="login-screen" class="flex flex-col items-center justify-center h-full">
            <div class="text-center mb-8 animate-bounce">
                <i class="fa-solid fa-crown text-6xl text-yellow-500 mb-4"></i>
            </div>
            <h2 class="text-3xl font-bold mb-2">æ­¡è¿æŒ‘æˆ°</h2>
            <p class="text-gray-400 mb-8 text-sm">AI å‡ºé¡Œ x çœŸäººå°æˆ° x å€‹æ€§è£æ‰®</p>
            <button onclick="googleLogin()" class="bg-white text-gray-800 hover:bg-gray-100 px-8 py-3 rounded-full font-bold shadow-lg transition flex items-center gap-2 transform hover:scale-105">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                ä½¿ç”¨ Google ç™»å…¥
            </button>
        </div>

        <div id="page-onboarding" class="page-section hidden absolute top-0 left-0 w-full h-full bg-slate-900 z-50 p-6 overflow-y-auto">
            <div class="max-w-md mx-auto mt-10">
                <h2 class="text-2xl font-bold text-blue-400 mb-2">ğŸ‘‹ å—¨ï¼åˆæ¬¡è¦‹é¢</h2>
                <div class="space-y-6">
                    <div>
                        <label class="block mb-2 text-sm font-bold text-white">ä½ æ˜¯å¹¾å¹´ç´šå­¸ç”Ÿï¼Ÿ</label>
                        <select id="ob-level" class="w-full bg-slate-800 border border-slate-600 text-white rounded-lg p-3">
                            <option value="åœ‹å°ä¸­å¹´ç´š">åœ‹å° (ä¸­å¹´ç´š)</option>
                            <option value="åœ‹å°é«˜å¹´ç´š">åœ‹å° (é«˜å¹´ç´š)</option>
                            <option value="åœ‹ä¸­ä¸€å¹´ç´š">åœ‹ä¸­ (ä¸€å¹´ç´š)</option>
                            <option value="åœ‹ä¸­äºŒå¹´ç´š">åœ‹ä¸­ (äºŒå¹´ç´š)</option>
                            <option value="åœ‹ä¸­ä¸‰å¹´ç´š">åœ‹ä¸­ (ä¸‰å¹´ç´š)</option>
                            <option value="é«˜ä¸­è·">é«˜ä¸­ / é«˜è·</option>
                            <option value="å¤§å­¸ä»¥ä¸Š">å¤§å­¸ / ç¤¾æœƒäººå£«</option>
                        </select>
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-bold text-green-400">æ“…é•·ç§‘ç›®</label>
                        <input type="text" id="ob-strong" class="w-full bg-slate-800 border border-slate-600 text-white rounded-lg p-3" placeholder="ä¾‹å¦‚ï¼šæ­·å², è‹±æ–‡">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-bold text-red-400">å¼±é …ç§‘ç›®</label>
                        <input type="text" id="ob-weak" class="w-full bg-slate-800 border border-slate-600 text-white rounded-lg p-3" placeholder="ä¾‹å¦‚ï¼šæ•¸å­¸, ç†åŒ–">
                    </div>
                    <button onclick="submitOnboarding()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg">é–‹å§‹æ—…ç¨‹ ğŸš€</button>
                </div>
            </div>
        </div>

        <div id="page-home" class="page-section hidden">
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-8 rounded-2xl shadow-xl text-center border border-slate-700 relative overflow-hidden">
                <i class="fa-solid fa-trophy absolute -bottom-4 -right-4 text-9xl text-white opacity-5 transform rotate-12"></i>
                <div class="text-gray-400 text-xs uppercase tracking-widest mb-2">Current Rank</div>
                <h2 class="text-5xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-orange-400 to-red-500" id="display-rank">è¼‰å…¥ä¸­</h2>
                <div class="flex justify-center items-center gap-2 mt-6 text-gray-300 bg-slate-800/50 inline-block px-4 py-1 rounded-full">
                    <i class="fa-solid fa-star text-yellow-400"></i>
                    <span>éšæ®µ: <span id="display-stars" class="font-bold text-white text-lg">0</span> / 10</span>
                </div>
                <div class="w-full bg-slate-950 rounded-full h-3 mt-6 overflow-hidden border border-slate-700">
                    <div id="progress-bar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                </div>
                
                <div class="flex gap-3 mt-8">
                    <button onclick="startQuizFlow()" class="flex-1 bg-blue-600 py-4 rounded-xl text-lg font-bold hover:bg-blue-500 shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-play"></i> å–®äººæŒ‘æˆ°
                    </button>
                    <button onclick="startBattleMatchmaking()" class="flex-1 bg-red-600 py-4 rounded-xl text-lg font-bold hover:bg-red-500 shadow-lg active:scale-95 transition flex items-center justify-center gap-2 border border-red-400/30">
                        <i class="fa-solid fa-khanda"></i> é›™äººå°æˆ°
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-4">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col items-center">
                    <div class="text-xs text-gray-400 mb-1"><i class="fa-solid fa-coins text-yellow-500"></i> ç¸½ç©åˆ†</div>
                    <div class="text-2xl font-bold text-white" id="display-score">0</div>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col items-center">
                    <div class="text-xs text-gray-400 mb-1"><i class="fa-solid fa-bullseye text-blue-400"></i> æ­£ç¢ºç‡</div>
                    <div class="text-2xl font-bold text-white" id="display-accuracy">0%</div>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col items-center">
                    <div class="text-xs text-gray-400 mb-1"><i class="fa-solid fa-fire text-orange-500"></i> ç•¶å‰é€£å°</div>
                    <div class="text-2xl font-bold text-orange-400" id="display-streak">0</div>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col items-center">
                    <div class="text-xs text-gray-400 mb-1"><i class="fa-solid fa-crown text-purple-500"></i> æœ€ä½³é€£å°</div>
                    <div class="text-2xl font-bold text-purple-400" id="display-best-streak">0</div>
                </div>
            </div>
        </div>

        <div id="page-shop" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-yellow-400">
                <i class="fa-solid fa-store"></i> ç©åˆ†å•†åº—
            </h2>
            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 mb-4 flex justify-between items-center">
                <span class="text-gray-400 text-sm">ä½ çš„ç©åˆ†</span>
                <span class="text-xl font-bold text-yellow-400"><i class="fa-solid fa-coins"></i> <span id="shop-user-score">0</span></span>
            </div>

            <div class="flex gap-2 mb-4">
                <button onclick="filterShop('avatar')" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-bold transition">é ­åƒ (Avatar)</button>
                <button onclick="filterShop('frame')" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-bold transition">é‚Šæ¡† (Frame)</button>
            </div>

            <div id="shop-grid" class="grid grid-cols-2 gap-3">
                </div>
        </div>

        <div id="page-quiz" class="page-section hidden pb-20">
            <div id="quiz-loading" class="text-center mt-32 hidden">
                <div class="loader"></div>
                <h3 class="text-xl font-bold mt-4 text-blue-300">é›²ç«¯å¤§è…¦é‹ç®—ä¸­</h3>
                <p class="text-xs text-gray-500 mt-2" id="loading-text">AI æ­£åœ¨è¶•å·¥å‡ºé¡Œä¸­...</p>
            </div>
            <div id="quiz-container" class="hidden">
                <div class="bg-slate-800 p-6 rounded-xl mb-6 border-t-4 border-blue-500 shadow-lg relative">
                    <span class="absolute top-4 right-4 bg-slate-900 text-xs px-2 py-1 rounded text-gray-400" id="quiz-badge">ä¸»é¡Œ</span>
                    <div class="text-4xl text-blue-500/20 absolute top-2 left-2"><i class="fa-solid fa-quote-left"></i></div>
                    <h3 class="text-lg font-bold leading-relaxed mt-4 relative z-10" id="question-text">...</h3>
                </div>
                <div id="options-container" class="space-y-3"></div>
                <div id="feedback-section" class="hidden mt-6 bg-slate-800 border border-slate-700 rounded-xl p-5 shadow-2xl animate-fade-in-up">
                    <div class="flex items-center gap-3 mb-3">
                        <div id="feedback-icon" class="text-2xl"></div>
                        <h3 id="feedback-title" class="text-xl font-bold"></h3>
                    </div>
                    <div class="bg-slate-900/50 p-4 rounded-lg text-sm text-gray-300 mb-4 leading-relaxed border border-slate-700/50">
                        <span class="text-blue-400 font-bold block mb-1">AI è§£æï¼š</span>
                        <span id="feedback-text"></span>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="switchToPage('page-home')" class="flex-1 bg-slate-700 hover:bg-slate-600 text-gray-300 py-3 rounded-lg font-bold">å¤§å»³</button>
                        <button onclick="nextQuestion()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold">ä¸‹ä¸€é¡Œ</button>
                    </div>
                </div>
                <button id="btn-giveup" onclick="giveUpQuiz()" class="mt-8 py-3 text-gray-500 text-sm w-full text-center">æ”¾æ£„</button>
            </div>
        </div>

        <div id="page-battle" class="page-section hidden">
            <div id="battle-lobby" class="flex flex-col items-center justify-center pt-20">
                <div class="radar-scan mb-8"><div class="radar-line"></div></div>
                <h2 class="text-2xl font-bold mb-2">æœå°‹å°æ‰‹ä¸­...</h2>
                <button onclick="leaveBattle()" class="border border-red-500 text-red-400 px-6 py-2 rounded-full mt-8 hover:bg-red-500/10">å–æ¶ˆé…å°</button>
            </div>
            <div id="battle-arena" class="hidden">
                <div class="flex justify-between items-center mb-6 bg-slate-900/50 p-4 rounded-xl border border-slate-700">
                    <div class="flex flex-col items-center">
                        <div class="avatar-container w-14 h-14">
                            <img id="p1-avatar" src="" class="avatar-img border-2 border-blue-500">
                            <img id="p1-frame" src="" class="avatar-frame hidden">
                        </div>
                        <span class="text-xs mt-1 font-bold text-blue-300" id="p1-name">æˆ‘æ–¹</span>
                        <span class="text-xl font-black" id="p1-score">0</span>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-black italic text-red-500/50">VS</div>
                        <div class="text-xs text-gray-400 mt-1">Round <span id="battle-round">1</span>/3</div>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="avatar-container w-14 h-14">
                            <img id="p2-avatar" src="" class="avatar-img border-2 border-red-500">
                            <img id="p2-frame" src="" class="avatar-frame hidden">
                        </div>
                        <span class="text-xs mt-1 font-bold text-red-300" id="p2-name">å°æ‰‹</span>
                        <span class="text-xl font-black" id="p2-score">0</span>
                    </div>
                </div>
                <div id="battle-loading" class="text-center py-10"><div class="loader"></div><p class="mt-4 text-blue-300">æº–å‚™é¡Œç›®ä¸­...</p></div>
                <div id="battle-quiz-box" class="hidden">
                    <div class="bg-slate-800 p-5 rounded-xl mb-4 border border-blue-500/30"><h3 class="text-lg font-bold" id="battle-q-text"></h3></div>
                    <div id="battle-options" class="space-y-3"></div>
                    <div id="battle-waiting-msg" class="hidden text-center text-yellow-400 mt-4 animate-pulse">ç­‰å¾…å°æ‰‹...</div>
                </div>
                <div id="battle-result" class="hidden text-center pt-10">
                    <h2 class="text-3xl font-bold mb-2" id="battle-result-title"></h2>
                    <p class="text-gray-400 mb-8" id="battle-result-msg"></p>
                    <button onclick="leaveBattle()" class="bg-blue-600 w-full py-3 rounded-xl font-bold">è¿”å›å¤§å»³</button>
                </div>
            </div>
        </div>

        <div id="page-rank" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-yellow-400"><i class="fa-solid fa-trophy"></i> å…¨æœæ’è¡Œæ¦œ</h2>
            <div class="bg-slate-800 rounded-xl overflow-hidden shadow-lg border border-slate-700">
                <table class="w-full text-left text-sm text-gray-300">
                    <thead class="bg-slate-900 text-gray-400 uppercase text-xs">
                        <tr><th class="px-4 py-3">#</th><th class="px-4 py-3">ç©å®¶</th><th class="px-4 py-3 text-right">æ®µä½</th></tr>
                    </thead>
                    <tbody id="leaderboard-body"></tbody>
                </table>
            </div>
        </div>

        <div id="page-settings" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-4">âš™ï¸ è¨­å®šèˆ‡è£æ‰®</h2>
            
            <div class="bg-slate-800 p-6 rounded-xl shadow-lg mb-6 border border-slate-700 flex flex-col items-center">
                <div class="avatar-container w-24 h-24 mb-4">
                    <img id="preview-avatar" src="" class="avatar-img border-4 border-slate-600">
                    <img id="preview-frame" src="" class="avatar-frame hidden">
                </div>
                <div class="flex gap-2 w-full">
                    <input type="text" id="setting-nickname" class="bg-slate-900 border border-slate-600 text-white text-center rounded-lg flex-1 p-2" placeholder="è¼¸å…¥æš±ç¨±">
                    <button onclick="updateNickname()" class="bg-blue-600 px-4 rounded-lg hover:bg-blue-500"><i class="fa-solid fa-check"></i></button>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="font-bold mb-2 text-gray-400 text-sm">æ›´æ›é ­åƒ (èƒŒåŒ…)</h3>
                <div id="inventory-avatars" class="flex gap-3 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-slate-600"></div>
            </div>
            <div class="mb-6">
                <h3 class="font-bold mb-2 text-gray-400 text-sm">æ›´æ›é‚Šæ¡† (èƒŒåŒ…)</h3>
                <div id="inventory-frames" class="flex gap-3 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-slate-600"></div>
            </div>

            <div class="bg-slate-800 p-6 rounded-xl shadow-lg mb-6 border border-slate-700 space-y-4">
                <div><label class="block mb-1 text-xs text-gray-400">å¹´ç´š</label><select id="set-level" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2"><option value="åœ‹ä¸­ä¸€å¹´ç´š">åœ‹ä¸­ä¸€å¹´ç´š</option></select></div>
                <div><label class="block mb-1 text-xs text-green-400">æ“…é•·</label><input type="text" id="set-strong" class="bg-slate-900 border border-slate-600 rounded-lg w-full p-2"></div>
                <div><label class="block mb-1 text-xs text-red-400">å¼±é …</label><input type="text" id="set-weak" class="bg-slate-900 border border-slate-600 rounded-lg w-full p-2"></div>
                <button onclick="saveProfile()" class="mt-2 bg-slate-700 text-white px-4 py-2 rounded-lg w-full font-bold">æ›´æ–°å­¸ç¿’è¨­å®š</button>
            </div>
            
            <button onclick="logout()" class="bg-red-900/30 border border-red-800/50 text-red-300 px-4 py-3 rounded-lg w-full">ç™»å‡º</button>
        </div>

        <div id="page-history" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-purple-400">
                <i class="fa-solid fa-clock-rotate-left"></i> æˆ‘çš„ç­”é¡Œç´€éŒ„
            </h2>
            <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 h-[75vh] flex flex-col shadow-2xl">
                <div class="p-3 bg-slate-900 border-b border-slate-700 font-bold text-xs text-gray-400 uppercase tracking-wider flex justify-between">
                    <span>å€‹äººå­¸ç¿’æ­·ç¨‹</span>
                    <button onclick="loadUserHistory()" class="text-blue-400 hover:text-white transition"><i class="fa-solid fa-rotate"></i></button>
                </div>
                <ul id="history-list" class="overflow-y-auto p-2 space-y-2 flex-1 text-sm scrollbar-thin scrollbar-thumb-slate-600">
                    <li class="text-center text-gray-500 py-10">è¼‰å…¥ä¸­...</li>
                </ul>
            </div>
        </div>

        <div id="page-admin" class="page-section hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-red-400 flex items-center gap-2"><i class="fa-solid fa-shield-halved"></i> ç®¡ç†å¾Œå°</h2>
                <button onclick="loadAdminLogs()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded transition"><i class="fa-solid fa-rotate"></i> åˆ·æ–°</button>
            </div>
            
            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 mb-4">
                <h3 class="font-bold mb-2">ä¸Šæ¶æ–°å•†å“</h3>
                <div class="space-y-2">
                    <input type="text" id="admin-item-name" placeholder="å•†å“åç¨±" class="w-full bg-slate-900 p-2 rounded text-sm text-white border border-slate-600">
                    <select id="admin-item-type" class="w-full bg-slate-900 p-2 rounded text-sm text-white border border-slate-600">
                        <option value="avatar">é ­åƒ (Avatar)</option>
                        <option value="frame">é‚Šæ¡† (Frame)</option>
                    </select>
                    <input type="number" id="admin-item-price" placeholder="åƒ¹æ ¼ (ç©åˆ†)" class="w-full bg-slate-900 p-2 rounded text-sm text-white border border-slate-600">
                    <input type="text" id="admin-item-url" placeholder="åœ–ç‰‡ç¶²å€ (URL)" class="w-full bg-slate-900 p-2 rounded text-sm text-white border border-slate-600">
                    <button onclick="addItemToShop()" class="bg-green-600 w-full py-2 rounded font-bold hover:bg-green-500 text-white">ä¸Šæ¶å•†å“</button>
                </div>
            </div>

            <div class="bg-slate-800 rounded-xl border border-slate-700 h-[40vh] overflow-hidden flex flex-col">
                <div class="p-3 bg-slate-900 border-b border-slate-700 text-xs text-gray-400 uppercase">ç›£æ§æ—¥èªŒ</div>
                <ul id="admin-logs-list" class="overflow-y-auto flex-1 p-2 text-xs text-gray-400 space-y-1 scrollbar-thin scrollbar-thumb-slate-600"></ul>
            </div>
        </div>
    </main>

    <nav id="bottom-nav" class="bg-slate-800/90 backdrop-blur-md border-t border-slate-700 fixed bottom-0 w-full z-50 hidden grid h-16 grid-cols-6 mx-auto font-medium" id="nav-grid">
        <button onclick="switchToPage('page-home')" class="flex flex-col items-center justify-center text-gray-400 active-nav-btn" data-target="page-home"><i class="fa-solid fa-house mb-1 text-lg"></i><span class="text-[10px]">é¦–é </span></button>
        <button onclick="startQuizFlow()" class="flex flex-col items-center justify-center text-gray-400" data-target="page-quiz"><i class="fa-solid fa-swords mb-1 text-lg"></i><span class="text-[10px]">ç­”é¡Œ</span></button>
        <button onclick="loadShop(); switchToPage('page-shop')" class="flex flex-col items-center justify-center text-gray-400" data-target="page-shop"><i class="fa-solid fa-store mb-1 text-lg"></i><span class="text-[10px]">å•†åŸ</span></button>
        <button onclick="loadLeaderboard(); switchToPage('page-rank')" class="flex flex-col items-center justify-center text-gray-400" data-target="page-rank"><i class="fa-solid fa-chart-simple mb-1 text-lg"></i><span class="text-[10px]">æ’è¡Œ</span></button>
        <button onclick="loadInventory(); switchToPage('page-settings')" class="flex flex-col items-center justify-center text-gray-400" data-target="page-settings"><i class="fa-solid fa-user-gear mb-1 text-lg"></i><span class="text-[10px]">è¨­å®š</span></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp, where, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDifdJmLTmwQATz__xUHSkXZ_xXOWyX-wU",
            authDomain: "question-learning.firebaseapp.com",
            projectId: "question-learning",
            storageBucket: "question-learning.firebasestorage.app",
            messagingSenderId: "1058543232092",
            appId: "1:1058543232092:web:3fcc40f5f069b6df307299",
            measurementId: "G-76ER8RGBN7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();
        const provider = new GoogleAuthProvider();
        
        let currentUserData = null;
        const RANKS = ["ğŸ¥‰ é’éŠ…", "ğŸ¥ˆ ç™½éŠ€", "ğŸ¥‡ é»ƒé‡‘", "ğŸ’ é‰‘é‡‘", "ğŸ”· é‘½çŸ³", "ğŸŒŸ æ˜Ÿè€€"];
        let quizBuffer = []; const BUFFER_SIZE = 1; let isFetchingBuffer = false; 
        let isBattleActive = false; let battleUnsub = null; let currentBattleId = null;

        const DEFAULT_AVATAR = "https://api.dicebear.com/7.x/adventurer/svg?seed=Felix";

        window.googleLogin = () => { signInWithPopup(auth, provider).catch(e => alert(e.message)); };
        window.logout = () => { localStorage.removeItem('currentQuiz'); signOut(auth).then(() => location.reload()); };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('bottom-nav').classList.remove('hidden');
                
                const userRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userRef);
                
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                    // è³‡æ–™é·ç§»ï¼šç¢ºä¿æœ‰æ–°æ¬„ä½
                    if (!currentUserData.inventory) {
                        await updateDoc(userRef, { inventory: ['default'], equipped: { avatar: DEFAULT_AVATAR, frame: '' } });
                        currentUserData.inventory = ['default'];
                        currentUserData.equipped = { avatar: DEFAULT_AVATAR, frame: '' };
                    }
                } else {
                    currentUserData = {
                        uid: user.uid, displayName: user.displayName, email: user.email,
                        profile: { educationLevel: "", strongSubjects: "", weakSubjects: "" },
                        stats: { rankLevel: 0, currentStars: 0, totalScore: 0, currentStreak: 0, bestStreak: 0, totalCorrect: 0, totalAnswered: 0 },
                        inventory: ['default'],
                        equipped: { avatar: DEFAULT_AVATAR, frame: '' },
                        isAdmin: false
                    };
                    await setDoc(userRef, currentUserData);
                }
                
                updateUIStats();
                updateHeaderUI();
                checkAdminRole(currentUserData.isAdmin);
                
                if (!currentUserData.profile?.educationLevel) switchToPage('page-onboarding');
                else { 
                    switchToPage('page-home'); 
                    fillBuffer(); 
                }
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        });

        // â­ UI æ›´æ–°
        function updateUIStats() {
            if(!currentUserData) return;
            const stats = currentUserData.stats;
            document.getElementById('display-rank').innerText = RANKS[stats.rankLevel] || "æœªçŸ¥";
            document.getElementById('display-stars').innerText = stats.currentStars;
            document.getElementById('display-score').innerText = stats.totalScore;
            document.getElementById('display-streak').innerText = stats.currentStreak || 0;
            document.getElementById('display-best-streak').innerText = stats.bestStreak || 0;
            
            // å•†åŸåˆ†æ•¸
            const shopScore = document.getElementById('shop-user-score');
            if(shopScore) shopScore.innerText = stats.totalScore;

            const accuracy = stats.totalAnswered > 0 ? ((stats.totalCorrect / stats.totalAnswered) * 100).toFixed(1) : "0.0";
            document.getElementById('display-accuracy').innerText = accuracy + "%";
            setTimeout(() => { document.getElementById('progress-bar').style.width = `${(stats.currentStars / 10) * 100}%`; }, 100);
        }

        function updateHeaderUI() {
            if(!currentUserData) return;
            const avatar = currentUserData.equipped?.avatar || DEFAULT_AVATAR;
            const frame = currentUserData.equipped?.frame || "";
            const name = currentUserData.displayName || "ç©å®¶";
            
            document.getElementById('header-avatar').src = avatar;
            const hFrame = document.getElementById('header-frame');
            if(frame) { hFrame.src = frame; hFrame.classList.remove('hidden'); } else { hFrame.classList.add('hidden'); }
            
            document.getElementById('user-info').innerText = name;

            document.getElementById('preview-avatar').src = avatar;
            const pFrame = document.getElementById('preview-frame');
            if(frame) { pFrame.src = frame; pFrame.classList.remove('hidden'); } else { pFrame.classList.add('hidden'); }
            document.getElementById('setting-nickname').value = name;
        }

        // ==========================================
        //  â­ å•†åŸèˆ‡èƒŒåŒ…ç³»çµ±
        // ==========================================
        window.loadShop = async () => {
            filterShop('avatar'); 
        };

        window.filterShop = async (type) => {
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = '<div class="loader col-span-2"></div>';
            
            const q = query(collection(db, "items"), where("type", "==", type));
            const snap = await getDocs(q);
            grid.innerHTML = '';

            snap.forEach(doc => {
                const item = doc.data();
                const isOwned = currentUserData.inventory.includes(doc.id);
                const card = document.createElement('div');
                card.className = "bg-slate-700 p-3 rounded-xl flex flex-col items-center relative border border-slate-600";
                
                let imgHTML = '';
                if(type === 'avatar') imgHTML = `<img src="${item.url}" class="w-16 h-16 rounded-full object-cover mb-2 border-2 border-slate-500">`;
                else imgHTML = `<div class="w-16 h-16 relative mb-2"><img src="${DEFAULT_AVATAR}" class="w-full h-full rounded-full opacity-50"><img src="${item.url}" class="absolute top-0 left-0 w-full h-full object-contain"></div>`;

                let btnHTML = '';
                if(isOwned) {
                    btnHTML = `<button class="w-full py-1 bg-gray-600 text-gray-300 text-xs rounded cursor-default">å·²æ“æœ‰</button>`;
                } else {
                    const canAfford = currentUserData.stats.totalScore >= item.price;
                    btnHTML = `<button onclick="buyItem('${doc.id}', ${item.price}, '${type}')" class="w-full py-1 ${canAfford ? 'bg-yellow-600 hover:bg-yellow-500' : 'bg-slate-600 cursor-not-allowed'} text-white text-xs rounded font-bold">ğŸ’° ${item.price}</button>`;
                }

                card.innerHTML = `
                    ${imgHTML}
                    <div class="text-sm font-bold mb-1">${item.name}</div>
                    ${btnHTML}
                `;
                grid.appendChild(card);
            });
        };

        window.buyItem = async (itemId, price, type) => {
            if(currentUserData.stats.totalScore < price) { alert("ç©åˆ†ä¸è¶³ï¼"); return; }
            if(!confirm(`ç¢ºå®šèŠ±è²» ${price} ç©åˆ†è³¼è²·å—ï¼Ÿ`)) return;

            currentUserData.stats.totalScore -= price;
            currentUserData.inventory.push(itemId);

            await updateDoc(doc(db, "users", auth.currentUser.uid), {
                "stats.totalScore": currentUserData.stats.totalScore,
                "inventory": currentUserData.inventory
            });

            alert("è³¼è²·æˆåŠŸï¼");
            updateUIStats();
            filterShop(type); 
        };

        window.loadInventory = () => {
            const avatarDiv = document.getElementById('inventory-avatars');
            const frameDiv = document.getElementById('inventory-frames');
            avatarDiv.innerHTML = ''; frameDiv.innerHTML = '';

            renderEquipItem(avatarDiv, 'default', DEFAULT_AVATAR, 'avatar', 'é è¨­');

            getDocs(collection(db, "items")).then(snap => {
                snap.forEach(doc => {
                    const item = doc.data();
                    if(currentUserData.inventory.includes(doc.id)) {
                        if(item.type === 'avatar') renderEquipItem(avatarDiv, doc.id, item.url, 'avatar', item.name);
                        else renderEquipItem(frameDiv, doc.id, item.url, 'frame', item.name);
                    }
                });
            });
        };

        function renderEquipItem(container, id, url, type, name) {
            const div = document.createElement('div');
            div.className = "flex-shrink-0 flex flex-col items-center cursor-pointer hover:bg-white/10 p-2 rounded transition";
            div.onclick = () => equipItem(type, url);
            
            if(type === 'avatar') {
                div.innerHTML = `<img src="${url}" class="w-12 h-12 rounded-full border-2 border-gray-500"><span class="text-[10px] mt-1">${name}</span>`;
            } else {
                div.innerHTML = `<div class="w-12 h-12 relative"><img src="${DEFAULT_AVATAR}" class="w-full h-full rounded-full opacity-30"><img src="${url}" class="absolute top-0 left-0 w-full h-full"></div><span class="text-[10px] mt-1">${name}</span>`;
            }
            container.appendChild(div);
        }

        window.equipItem = async (type, url) => {
            if(type === 'avatar') currentUserData.equipped.avatar = url;
            if(type === 'frame') currentUserData.equipped.frame = url;
            
            await updateDoc(doc(db, "users", auth.currentUser.uid), { equipped: currentUserData.equipped });
            updateHeaderUI();
        };

        window.updateNickname = async () => {
            const newName = document.getElementById('setting-nickname').value.trim();
            if(!newName) return;
            await updateDoc(doc(db, "users", auth.currentUser.uid), { displayName: newName });
            currentUserData.displayName = newName;
            updateHeaderUI();
            alert("æš±ç¨±å·²æ›´æ–°ï¼");
        };

        window.addItemToShop = async () => {
            const name = document.getElementById('admin-item-name').value;
            const type = document.getElementById('admin-item-type').value;
            const price = parseInt(document.getElementById('admin-item-price').value);
            const url = document.getElementById('admin-item-url').value;

            if(!name || !price || !url) { alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š"); return; }

            try {
                await addDoc(collection(db, "items"), { name, type, price, url, createdAt: serverTimestamp() });
                alert("ä¸Šæ¶æˆåŠŸï¼");
                document.getElementById('admin-item-name').value = '';
                document.getElementById('admin-item-url').value = '';
            } catch(e) { alert("ä¸Šæ¶å¤±æ•—: " + e.message); }
        };

        // ==========================================
        //  é€šç”¨åŠŸèƒ½ (å°æˆ°ã€ç­”é¡Œã€UI)
        // ==========================================
        window.switchToPage = (pageId) => {
            if (isBattleActive && pageId !== 'page-battle') { alert("âš”ï¸ æˆ°é¬¥ä¸­ç„¡æ³•é›¢é–‹ï¼"); return; }
            document.querySelectorAll('.page-section').forEach(el => { el.classList.remove('active-page', 'hidden'); el.classList.add('hidden'); });
            const target = document.getElementById(pageId); if(target) { target.classList.remove('hidden'); target.classList.add('active-page'); }
            document.querySelectorAll('#nav-grid button').forEach(btn => {
                if(isBattleActive) btn.classList.add('nav-locked'); else btn.classList.remove('nav-locked');
                if (btn.dataset.target === pageId) { btn.classList.add('text-white'); btn.classList.remove('text-gray-400'); } else { btn.classList.remove('text-white'); btn.classList.add('text-gray-400'); }
            });
        };

        function checkAdminRole(isAdmin) {
            const navGrid = document.getElementById('nav-grid');
            if (isAdmin && !document.getElementById('btn-admin-nav')) {
                const btn = document.createElement('button'); btn.id = "btn-admin-nav"; btn.dataset.target = "page-admin";
                btn.className = "flex flex-col items-center justify-center text-gray-400";
                btn.onclick = () => { loadAdminLogs(); switchToPage('page-admin'); };
                btn.innerHTML = `<i class="fa-solid fa-user-shield mb-1 text-lg text-red-400"></i><span class="text-[10px]">ç®¡ç†</span>`;
                navGrid.appendChild(btn);
            }
        }

        // å°æˆ°ç›¸é—œ
        window.startBattleMatchmaking = async () => {
            isBattleActive = true; switchToPage('page-battle');
            document.getElementById('battle-lobby').classList.remove('hidden'); document.getElementById('battle-arena').classList.add('hidden');
            const q = query(collection(db, "rooms"), where("status", "==", "waiting"), limit(1));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                currentBattleId = snapshot.docs[0].id;
                await updateDoc(doc(db, "rooms", currentBattleId), {
                    guest: { uid: auth.currentUser.uid, name: currentUserData.displayName, score: 0, done: false, equipped: currentUserData.equipped },
                    status: "ready"
                });
            } else {
                const roomRef = await addDoc(collection(db, "rooms"), {
                    host: { uid: auth.currentUser.uid, name: currentUserData.displayName, score: 0, done: false, equipped: currentUserData.equipped },
                    guest: null, status: "waiting", round: 1, createdAt: serverTimestamp()
                });
                currentBattleId = roomRef.id;
            }
            listenToBattleRoom(currentBattleId);
        };

        function listenToBattleRoom(roomId) {
            if (battleUnsub) battleUnsub();
            battleUnsub = onSnapshot(doc(db, "rooms", roomId), async (docSnap) => {
                if (!docSnap.exists()) return;
                const room = docSnap.data();
                const isHost = room.host.uid === auth.currentUser.uid;

                if (room.status === "ready") {
                    document.getElementById('battle-lobby').classList.add('hidden'); document.getElementById('battle-arena').classList.remove('hidden');
                    const p1 = isHost ? room.host : room.guest;
                    const p2 = isHost ? room.guest : room.host;
                    
                    document.getElementById('p1-name').innerText = p1.name;
                    document.getElementById('p1-score').innerText = p1.score;
                    document.getElementById('p1-avatar').src = p1.equipped?.avatar || DEFAULT_AVATAR;
                    if(p1.equipped?.frame) { document.getElementById('p1-frame').src = p1.equipped.frame; document.getElementById('p1-frame').classList.remove('hidden'); }

                    document.getElementById('p2-name').innerText = p2.name;
                    document.getElementById('p2-score').innerText = p2.score;
                    document.getElementById('p2-avatar').src = p2.equipped?.avatar || DEFAULT_AVATAR;
                    if(p2.equipped?.frame) { document.getElementById('p2-frame').src = p2.equipped.frame; document.getElementById('p2-frame').classList.remove('hidden'); }

                    if (!room.currentQuestion && isHost) generateSharedQuiz(roomId);
                    
                    if (room.currentQuestion) {
                        document.getElementById('battle-loading').classList.add('hidden'); document.getElementById('battle-quiz-box').classList.remove('hidden');
                        document.getElementById('battle-q-text').innerText = room.currentQuestion.q;
                        const container = document.getElementById('battle-options'); container.innerHTML = '';
                        const myData = isHost ? room.host : room.guest;
                        if (!myData.done) {
                            document.getElementById('battle-waiting-msg').classList.add('hidden');
                            room.currentQuestion.opts.forEach((opt, idx) => {
                                const btn = document.createElement('button'); btn.className = "w-full text-left p-4 bg-slate-700 hover:bg-slate-600 rounded-lg transition border border-slate-600"; btn.innerText = opt;
                                btn.onclick = () => handleBattleAnswer(roomId, idx, room.currentQuestion.ans, isHost); container.appendChild(btn);
                            });
                        } else {
                            container.innerHTML = ''; document.getElementById('battle-waiting-msg').classList.remove('hidden');
                        }
                    }
                    if (room.host.done && room.guest.done && isHost) {
                        setTimeout(async () => {
                            if (room.round >= 3) await updateDoc(doc(db, "rooms", roomId), { status: "finished" });
                            else await updateDoc(doc(db, "rooms", roomId), { round: room.round + 1, currentQuestion: null, "host.done": false, "guest.done": false });
                        }, 2000);
                    }
                }
                if (room.status === "finished") {
                    document.getElementById('battle-arena').classList.add('hidden'); document.getElementById('battle-result').classList.remove('hidden');
                    const myScore = isHost ? room.host.score : room.guest.score; const oppScore = isHost ? room.guest.score : room.host.score;
                    const title = document.getElementById('battle-result-title');
                    if (myScore > oppScore) { title.innerText = "ğŸ‰ å‹åˆ©ï¼"; title.className = "text-3xl font-bold mb-2 text-green-400"; }
                    else if (myScore < oppScore) { title.innerText = "ğŸ’” æƒœæ•—..."; title.className = "text-3xl font-bold mb-2 text-red-400"; }
                    else { title.innerText = "ğŸ¤ å¹³æ‰‹"; title.className = "text-3xl font-bold mb-2 text-yellow-400"; }
                    document.getElementById('battle-result-msg').innerText = `${myScore} : ${oppScore}`;
                }
            });
        }

        async function handleBattleAnswer(roomId, idx, ans, isHost) {
            const isCorrect = idx === ans; const score = isCorrect ? 100 : 0;
            const field = isHost ? "host" : "guest";
            const roomSnap = await getDoc(doc(db, "rooms", roomId));
            const currentScore = roomSnap.data()[field].score;
            await updateDoc(doc(db, "rooms", roomId), { [`${field}.score`]: currentScore + score, [`${field}.done`]: true });
        }

        async function generateSharedQuiz(roomId) {
            try { const q = await fetchOneQuestion(); await updateDoc(doc(db, "rooms", roomId), { currentQuestion: { q: q.data.q, opts: q.data.opts, ans: q.data.ans } }); } catch (e) {}
        }

        window.leaveBattle = () => { if (battleUnsub) battleUnsub(); isBattleActive = false; currentBattleId = null; switchToPage('page-home'); };

        // æ’è¡Œæ¦œæ›´æ–° (é¡¯ç¤ºè‡ªè¨‚é ­åƒ)
        window.loadLeaderboard = async () => {
            const tbody = document.getElementById('leaderboard-body'); tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4"><div class="loader"></div></td></tr>';
            try {
                const q = query(collection(db, "users"), orderBy("stats.totalScore", "desc"), limit(10));
                const snap = await getDocs(q); tbody.innerHTML = '';
                let i = 1;
                snap.forEach(doc => {
                    const d = doc.data(); const isMe = auth.currentUser && d.uid === auth.currentUser.uid;
                    const avatar = d.equipped?.avatar || DEFAULT_AVATAR;
                    const frame = d.equipped?.frame ? `<img src="${d.equipped.frame}" class="absolute top-0 left-0 w-full h-full scale-110 object-contain">` : '';
                    
                    const row = `
                        <tr class="border-b border-slate-700/50 ${isMe ? 'bg-blue-900/20' : ''}">
                            <td class="px-4 py-4 font-bold ${i===1?'text-yellow-400':(i===2?'text-gray-300':(i===3?'text-orange-400':'text-gray-500'))}">${i}</td>
                            <td class="px-4 py-4 flex items-center gap-2">
                                <div class="w-8 h-8 relative shrink-0">
                                    <img src="${avatar}" class="w-full h-full rounded-full object-cover">
                                    ${frame}
                                </div>
                                <span class="${isMe ? 'text-blue-300 font-bold' : ''}">${d.displayName}</span>
                            </td>
                            <td class="px-4 py-4 text-right font-mono text-blue-300">${RANKS[d.stats.rankLevel] || "é’éŠ…"} <span class="text-xs text-gray-500 block">${d.stats.totalScore} pts</span></td>
                        </tr>`;
                    tbody.innerHTML += row; i++;
                });
            } catch (e) { tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-red-400">è®€å–å¤±æ•—</td></tr>'; }
        };

        // å–®äººå‡ºé¡Œé‚è¼¯
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
        
        async function fetchOneQuestion() {
            const rankName = RANKS[currentUserData.stats.rankLevel];
            const level = currentUserData.profile.educationLevel || "ä¸€èˆ¬";
            let rawWeakString = currentUserData.profile.weakSubjects || "";
            let targetSubject = "";
            let subjectsArray = rawWeakString.split(/[,ï¼Œ\s]+/).filter(s => s.trim().length > 0);
            
            if (subjectsArray.length > 0) { targetSubject = subjectsArray[Math.floor(Math.random() * subjectsArray.length)]; } 
            else { const generalTopics = ["å°ç£æ­·å²", "ä¸–ç•Œåœ°ç†", "ç”Ÿæ´»ç§‘å­¸", "é‚è¼¯æ¨ç†", "åœ‹èªæ–‡å¸¸è­˜", "ç§‘æŠ€æ–°çŸ¥", "å‹•æ¼«èˆ‡éŠæˆ²", "ç’°å¢ƒä¿è‚²"]; targetSubject = generalTopics[Math.floor(Math.random() * generalTopics.length)]; }

            const response = await fetch("/api/generate-quiz", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ subject: targetSubject, level: level, rank: rankName }) });
            const data = await response.json(); 
            let text = data.text.match(/\{[\s\S]*\}/)[0];
            const raw = JSON.parse(text);
            let opts = [raw.correct, ...raw.wrong]; opts = shuffleArray(opts);
            return { data: { q: raw.q, opts: opts, ans: opts.indexOf(raw.correct), exp: raw.exp }, rank: rankName, badge: `ğŸ¯ ${targetSubject}` };
        }
        
        async function fillBuffer() { if (!isFetchingBuffer && quizBuffer.length < BUFFER_SIZE) { isFetchingBuffer = true; try { while(quizBuffer.length < BUFFER_SIZE) quizBuffer.push(await fetchOneQuestion()); } catch(e){} isFetchingBuffer = false; } }
        
        window.startQuizFlow = async () => { switchToPage('page-quiz'); document.getElementById('quiz-container').classList.add('hidden'); document.getElementById('feedback-section').classList.add('hidden'); document.getElementById('btn-giveup').classList.remove('hidden'); if(quizBuffer.length>0) { const q = quizBuffer.shift(); renderQuiz(q.data, q.rank, q.badge); fillBuffer(); } else { document.getElementById('quiz-loading').classList.remove('hidden'); try{ const q = await fetchOneQuestion(); renderQuiz(q.data, q.rank, q.badge); fillBuffer(); }catch(e){alert("å‡ºé¡Œå¤±æ•—");switchToPage('page-home');} } };
        
        function renderQuiz(data, rank, topic) { document.getElementById('quiz-loading').classList.add('hidden'); document.getElementById('quiz-container').classList.remove('hidden'); document.getElementById('question-text').innerText = data.q; const c = document.getElementById('options-container'); c.innerHTML=''; data.opts.forEach((o,i)=>{ const b=document.createElement('button'); b.className="w-full text-left p-4 bg-slate-700 hover:bg-slate-600 rounded-lg mb-2 border border-slate-600 active:scale-95 transition"; b.innerText=o; b.onclick=()=>handleAnswer(i,data.ans,data.q,data.exp); c.appendChild(b); }); }
        
        async function handleAnswer(u, c, q, exp) { 
            const isC = u===c; 
            // æŒ‰éˆ•é–å®š
            const opts = document.querySelectorAll('[id^="option-btn-"]');
            document.getElementById('feedback-section').classList.remove('hidden'); 
            document.getElementById('btn-giveup').classList.add('hidden');
            
            const fbTitle = document.getElementById('feedback-title');
            const fbIcon = document.getElementById('feedback-icon');
            
            if(isC) {
                fbTitle.innerText = "å›ç­”æ­£ç¢ºï¼"; fbTitle.className = "text-xl font-bold text-green-400";
                fbIcon.innerHTML = '<i class="fa-solid fa-circle-check text-green-400"></i>';
            } else {
                fbTitle.innerText = "å›ç­”éŒ¯èª¤..."; fbTitle.className = "text-xl font-bold text-red-400";
                fbIcon.innerHTML = '<i class="fa-solid fa-circle-xmark text-red-400"></i>';
            }
            document.getElementById('feedback-text').innerText = exp;
            
            let s = currentUserData.stats; s.totalAnswered++;
            if(isC) { s.totalCorrect++; s.currentStreak++; s.totalScore+=10; if(s.currentStreak>s.bestStreak)s.bestStreak=s.currentStreak; s.currentStars++; if (s.currentStars >= 10 && s.rankLevel < RANKS.length - 1) { s.rankLevel++; s.currentStars = 0; } } 
            else { s.currentStreak=0; s.currentStars--; if (s.currentStars < 0 && s.rankLevel > 0) { s.rankLevel--; s.currentStars = 8; } }
            
            await updateDoc(doc(db, "users", auth.currentUser.uid), { stats: s });
            addDoc(collection(db, "exam_logs"), { uid: auth.currentUser.uid, email: auth.currentUser.email, question: q, isCorrect: isC, rankAtTime: RANKS[s.rankLevel], timestamp: serverTimestamp() }).catch(e=>{});
            updateUIStats(); fillBuffer();
        }
        
        window.nextQuestion = () => startQuizFlow();
        window.giveUpQuiz = () => handleAnswer(-1,-2,document.getElementById('question-text').innerText,"æ”¾æ£„");
        
        window.loadUserHistory = async () => {
            const ul = document.getElementById('history-list'); ul.innerHTML = '<div class="loader"></div>';
            const snap = await getDocs(query(collection(db, "exam_logs"), where("uid", "==", auth.currentUser.uid), orderBy("timestamp", "desc"), limit(20)));
            ul.innerHTML = ''; snap.forEach(doc => { const d=doc.data(); ul.innerHTML += `<li class="p-2 bg-slate-700/50 rounded mb-2 border-l-4 ${d.isCorrect?'border-green-500':'border-red-500'}"><div class="flex justify-between text-xs text-gray-400"><span>${d.timestamp?.toDate().toLocaleTimeString()}</span><span class="${d.isCorrect?'text-green-400':'text-red-400'}">${d.isCorrect?'CORRECT':'WRONG'}</span></div><div class="text-sm mt-1">${d.question}</div></li>`; });
        };
        
        window.loadAdminLogs = async () => {
            const ul = document.getElementById('admin-logs-list'); ul.innerHTML = '<div class="loader"></div>';
            const snap = await getDocs(query(collection(db, "exam_logs"), orderBy("timestamp", "desc"), limit(30)));
            ul.innerHTML = ''; snap.forEach(doc => { const d=doc.data(); ul.innerHTML += `<li class="p-2 bg-slate-700/50 rounded mb-1 text-xs border-l-2 ${d.isCorrect?'border-green-500':'border-red-500'}"><span class="text-gray-400">${d.email?.split('@')[0]}</span>: ${d.question.substring(0,20)}...</li>`; });
        };
    </script>
</body>
</html>
